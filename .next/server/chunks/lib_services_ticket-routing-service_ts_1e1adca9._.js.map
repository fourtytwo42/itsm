{"version":3,"sources":["../../../lib/services/ticket-routing-service.ts"],"sourcesContent":["import prisma from '@/lib/prisma'\nimport { notifyTicketAssigned } from '@/lib/services/notification-service'\nimport { wsServer } from '@/lib/websocket/server'\nimport { TicketStatus } from '@prisma/client'\n\nexport interface RouteTicketInput {\n  ticketId: string\n  tenantId?: string | null\n  category?: string | null\n}\n\n/**\n * Route ticket to an agent based on category assignments\n * Uses round-robin approach among available agents\n */\nexport async function routeTicketByCategory(input: RouteTicketInput) {\n  if (!input.tenantId || !input.category) {\n    return null // No routing possible without tenant and category\n  }\n\n  // Find all agents/managers assigned to this tenant + category\n  const assignments = await prisma.tenantAssignment.findMany({\n    where: {\n      tenantId: input.tenantId,\n      OR: [\n        { category: input.category }, // Specific category assignment\n        { category: null }, // All categories assignment\n      ],\n    },\n    include: {\n      user: {\n        include: {\n          roles: {\n            include: {\n              role: true,\n            },\n          },\n        },\n      },\n    },\n  })\n\n  // Filter to only AGENT and IT_MANAGER roles\n  const eligibleUsers = assignments\n    .map((a) => a.user)\n    .filter((user) => {\n      const roles = user.roles.map((ur) => ur.role.name)\n      return roles.includes('AGENT') || roles.includes('IT_MANAGER')\n    })\n\n  if (eligibleUsers.length === 0) {\n    return null // No eligible agents found\n  }\n\n  // Get current ticket counts for each agent to implement load balancing\n  const agentLoads = await Promise.all(\n    eligibleUsers.map(async (user) => {\n      const ticketCount = await prisma.ticket.count({\n        where: {\n          assigneeId: user.id,\n          status: {\n            in: [TicketStatus.NEW, TicketStatus.IN_PROGRESS],\n          },\n        },\n      })\n      return { userId: user.id, load: ticketCount }\n    })\n  )\n\n  // Sort by load (ascending) and pick the agent with least load\n  agentLoads.sort((a, b) => a.load - b.load)\n  const selectedAgentId = agentLoads[0].userId\n\n  return selectedAgentId\n}\n\n/**\n * Assign ticket to an agent and notify them\n */\nexport async function assignTicketToAgent(ticketId: string, agentId: string) {\n  const ticket = await prisma.ticket.findUnique({\n    where: { id: ticketId },\n    select: {\n      id: true,\n      ticketNumber: true,\n      subject: true,\n    },\n  })\n\n  if (!ticket) {\n    throw new Error('Ticket not found')\n  }\n\n  await prisma.ticket.update({\n    where: { id: ticketId },\n    data: { assigneeId: agentId },\n  })\n\n  // Notify the assigned agent\n  await notifyTicketAssigned(ticketId, ticket.ticketNumber, agentId)\n\n  // Broadcast WebSocket event\n  wsServer.broadcastToUser(agentId, 'ticket:assigned', {\n    ticket: {\n      id: ticket.id,\n      ticketNumber: ticket.ticketNumber,\n      subject: ticket.subject,\n    },\n  })\n\n  return ticket\n}\n\n"],"names":[],"mappings":"uCAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OAYO,eAAe,EAAsB,CAAuB,EACjE,GAAI,CAAC,EAAM,QAAQ,EAAI,CAAC,EAAM,QAAQ,CACpC,CADsC,MAC/B,KAAK,AA0Bd,IAAM,EAAgB,CAtBF,MAAM,EAAA,OAAM,CAAC,gBAAgB,CAAC,QAAQ,CAAC,CAJK,AAK9D,MAAO,CACL,SAAU,EAAM,QAAQ,CACxB,GAAI,CACF,CAAE,SAAU,EAAM,QAAQ,AAAC,EAC3B,CAAE,SAAU,IAAK,EAClB,AACH,EACA,QAAS,CACP,KAAM,CACJ,QAAS,CACP,MAAO,CACL,QAAS,CACP,MAAM,CACR,CACF,CACF,CACF,CACF,CACF,EAAA,EAIG,GAAG,CAAE,AAAD,GAAO,EAAE,IAAI,EACjB,MAAM,CAAC,AAAC,IACP,IAAM,EAAQ,EAAK,KAAK,CAAC,GAAG,CAAC,AAAC,GAAO,EAAG,IAAI,CAAC,IAAI,EACjD,OAAO,EAAM,QAAQ,CAAC,UAAY,EAAM,QAAQ,CAAC,aACnD,GAEF,GAA6B,GAAG,CAA5B,EAAc,MAAM,CACtB,OAAO,KAAK,AAId,IAAM,EAAa,MAAM,QAAQ,GAAG,CAClC,EAAc,CALyB,EAKtB,CAAC,MAAO,IACvB,IAAM,EAAc,MAAM,EAAA,OAAM,CAAC,MAAM,CAAC,KAAK,CAAC,CAC5C,MAAO,CACL,WAAY,EAAK,EAAE,CACnB,OAAQ,CACN,GAAI,CAAC,EAAA,YAAY,CAAC,GAAG,CAAE,EAAA,YAAY,CAAC,WAAW,CAAC,AAClD,CACF,CACF,GACA,MAAO,CAAE,OAAQ,EAAK,EAAE,CAAE,KAAM,CAAY,CAC9C,IAOF,OAAO,AAHP,EAAW,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,IAAI,CAAG,EAAE,IAAI,EACjB,CAAU,CAAC,EAAE,CAAC,MAAM,AAG9C,CAKO,eAAe,EAAoB,CAAgB,CAAE,CAAe,EACzE,IAAM,EAAS,MAAM,EAAA,OAAM,CAAC,MAAM,CAAC,UAAU,CAAC,CAC5C,MAAO,CAAE,GAAI,CAAS,EACtB,OAAQ,CACN,IAAI,EACJ,cAAc,EACd,SAAS,CACX,CACF,GAEA,GAAI,CAAC,EACH,MAAM,AAAI,AADC,MACK,oBAoBlB,OAjBA,MAAM,EAAA,OAAM,CAAC,MAAM,CAAC,MAAM,CAAC,CACzB,MAAO,CAAE,GAAI,CAAS,EACtB,KAAM,CAAE,WAAY,CAAQ,CAC9B,GAGA,MAAM,CAAA,EAAA,EAAA,oBAAoB,AAApB,EAAqB,EAAU,EAAO,YAAY,CAAE,GAG1D,EAAA,QAAQ,CAAC,eAAe,CAAC,EAAS,kBAAmB,CACnD,OAAQ,CACN,GAAI,EAAO,EAAE,CACb,aAAc,EAAO,YAAY,CACjC,QAAS,EAAO,OAAO,AACzB,CACF,GAEO,CACT"}