module.exports=[70406,(e,t,a)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},18622,(e,t,a)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},24361,(e,t,a)=>{t.exports=e.x("util",()=>require("util"))},93695,(e,t,a)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},29173,(e,t,a)=>{t.exports=e.x("@prisma/client",()=>require("@prisma/client"))},15270,e=>{"use strict";var t=e.i(29173);let a=globalThis.prisma??new t.PrismaClient({log:["error"]});e.s(["default",0,a])},32932,e=>{"use strict";var t=e.i(86687),a=e.i(68105);async function n(e){try{let n=e.headers.get("authorization");if(!n||!n.startsWith("Bearer "))return null;let r=n.substring(7),i=(0,t.verifyToken)(r),s=await (0,a.getUserById)(i.userId);if(!s||!s.isActive)return null;let o=s.roles.map(e=>e.role?.name||(e.customRole?`CUSTOM:${e.customRole.name}`:null)).filter(e=>null!==e),l=o.includes("GLOBAL_ADMIN");return{user:{id:s.id,email:s.email,roles:o,organizationId:s.organizationId||void 0,isGlobalAdmin:l},organizationId:s.organizationId||void 0}}catch(e){return null}}function r(e){if(!e)throw Error("Unauthorized")}function i(e,t){if(r(e),!e.user.roles.includes(t))throw Error("Forbidden: Insufficient permissions")}function s(e,t){if(r(e),!t.some(t=>e.user.roles.includes(t)))throw Error("Forbidden: Insufficient permissions")}e.s(["getAuthContext",()=>n,"requireAnyRole",()=>s,"requireAuth",()=>r,"requireRole",()=>i])},98220,e=>{"use strict";var t=e.i(15270);async function a(e){return e.organizationId&&!await s(e.organizationId,e.eventType)?null:t.default.auditLog.create({data:{organizationId:e.organizationId,eventType:e.eventType,entityType:e.entityType,entityId:e.entityId,userId:e.userId,userEmail:e.userEmail,description:e.description,metadata:e.metadata?e.metadata:null,ipAddress:e.ipAddress,userAgent:e.userAgent}})}async function n(e={}){let{organizationId:a,eventType:r,entityType:i,entityId:s,userId:o,startDate:l,endDate:d,page:u=1,limit:m=50}=e,c={};void 0!==a&&(c.organizationId=a),r&&(c.eventType=r),i&&(c.entityType=i),s&&(c.entityId=s),o&&(c.userId=o),(l||d)&&(c.createdAt={},l&&(c.createdAt.gte=l),d&&(c.createdAt.lte=d));let[f,p]=await Promise.all([t.default.auditLog.findMany({where:c,skip:(u-1)*m,take:m,orderBy:{createdAt:"desc"},include:{user:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},organization:{select:{id:!0,name:!0,slug:!0}}}}),t.default.auditLog.count({where:c})]);return{logs:f,pagination:{page:u,limit:m,total:p,totalPages:Math.ceil(p/m)}}}async function r(e){return t.default.auditConfig.findUnique({where:{organizationId:e}})}async function i(e,a){return t.default.auditConfig.upsert({where:{organizationId:e},update:{enabled:a.enabled,events:a.events,retentionDays:a.retentionDays},create:{organizationId:e,enabled:a.enabled??!0,events:a.events??[],retentionDays:a.retentionDays}})}async function s(e,a){let n=await t.default.auditConfig.findUnique({where:{organizationId:e}});return!!n&&!!n.enabled&&n.events.includes(a)}e.s(["getAuditConfig",()=>r,"getAuditLogs",()=>n,"logEvent",()=>a,"updateAuditConfig",()=>i])},43934,e=>{"use strict";var t=e.i(98220);async function a(e,a,n,r,i,s,o,l){let d=l?.headers.get("x-forwarded-for")||l?.headers.get("x-real-ip")||"unknown",u=l?.headers.get("user-agent")||"unknown",m=o?.organizationId??null;try{await (0,t.logEvent)({organizationId:m,eventType:e,entityType:a,entityId:n,userId:r,userEmail:i,description:s,metadata:o,ipAddress:Array.isArray(d)?d[0]:d,userAgent:u})}catch(e){console.error("Failed to log audit event:",e)}}e.s(["auditLog",()=>a])},22366,e=>{"use strict";var t=e.i(15270),a=e.i(29173);async function n(e){if(await t.default.customRole.findUnique({where:{organizationId_name:{organizationId:e.organizationId,name:e.name}}}))throw Error(`Custom role with name "${e.name}" already exists in this organization`);return t.default.customRole.create({data:{name:e.name,displayName:e.displayName,description:e.description,organizationId:e.organizationId,isActive:e.isActive??!0}})}async function r(e){return t.default.customRole.findUnique({where:{id:e},include:{organization:!0,userRoles:{include:{user:{select:{id:!0,email:!0,firstName:!0,lastName:!0}}}}}})}async function i(e,a){return t.default.customRole.findMany({where:{organizationId:e,...a?.isActive!==void 0&&{isActive:a.isActive}},orderBy:{displayName:"asc"},include:{_count:{select:{userRoles:!0}}}})}async function s(e,a){let n=await t.default.customRole.findUnique({where:{id:e}});if(!n)throw Error("Custom role not found");if(a.name&&a.name!==n.name&&await t.default.customRole.findUnique({where:{organizationId_name:{organizationId:n.organizationId,name:a.name}}}))throw Error(`Custom role with name "${a.name}" already exists in this organization`);return t.default.customRole.update({where:{id:e},data:a})}async function o(e){let a=await t.default.userRole.count({where:{customRoleId:e}});if(a>0)throw Error(`Cannot delete custom role: ${a} user(s) are assigned to this role`);return t.default.customRole.delete({where:{id:e}})}async function l(e){let[n,r]=await Promise.all([Promise.resolve([{type:"system",id:a.RoleName.AGENT,name:"Agent",displayName:"Agent"},{type:"system",id:a.RoleName.IT_MANAGER,name:"IT Manager",displayName:"IT Manager"}]),t.default.customRole.findMany({where:{organizationId:e,isActive:!0},select:{id:!0,name:!0,displayName:!0}}).then(e=>e.map(e=>({type:"custom",id:e.id,name:e.name,displayName:e.displayName})))]);return[...n,...r]}async function d(e,n){let r=await t.default.user.findMany({where:{organizationId:e,isActive:!0,deletedAt:null,roles:{some:{OR:[{role:{name:{in:[a.RoleName.AGENT,a.RoleName.IT_MANAGER]}}},{customRole:{isNot:null}}]}},NOT:{roles:{some:{role:{name:{in:[a.RoleName.ADMIN,a.RoleName.END_USER]}}}}}},include:{roles:{include:{role:!0,customRole:!0}},tenantAssignments:n?{where:{tenantId:n,category:null}}:void 0}});return(n?r.filter(e=>e.tenantAssignments.length>0||0===e.tenantAssignments.length&&!e.tenantId):r).map(e=>{let t=e.roles.map(e=>e.role?.name||(e.customRole?`CUSTOM:${e.customRole.name}`:null)).filter(e=>null!==e),a=e.roles.find(e=>e.role?.name)?.role?.name||e.roles.find(e=>e.customRole)?.customRole?.displayName||"Unknown";return{id:e.id,email:e.email,firstName:e.firstName,lastName:e.lastName,roles:t,primaryRole:a,displayName:e.firstName&&e.lastName?`${e.firstName} ${e.lastName}`:e.email}})}e.s(["createCustomRole",()=>n,"deleteCustomRole",()=>o,"getAvailableRolesForEscalation",()=>l,"getAvailableUsersForEscalation",()=>d,"getCustomRoleById",()=>r,"listCustomRoles",()=>i,"updateCustomRole",()=>s])},35683,e=>{"use strict";var t=e.i(15270);async function a(e){return t.default.ticketHistory.create({data:{ticketId:e.ticketId,type:e.type,userId:e.userId,oldValue:e.oldValue||null,newValue:e.newValue||null,note:e.note||null,metadata:e.metadata?e.metadata:null},include:{user:{select:{id:!0,email:!0,firstName:!0,lastName:!0}}}})}e.s(["createTicketHistory",()=>a])}];

//# sourceMappingURL=%5Broot-of-the-server%5D__0fd72f31._.js.map