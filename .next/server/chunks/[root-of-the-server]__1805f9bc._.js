module.exports=[70406,(e,t,s)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},18622,(e,t,s)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,s)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,s)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,s)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},24361,(e,t,s)=>{t.exports=e.x("util",()=>require("util"))},93695,(e,t,s)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},29173,(e,t,s)=>{t.exports=e.x("@prisma/client",()=>require("@prisma/client"))},15270,e=>{"use strict";var t=e.i(29173);let s=globalThis.prisma??new t.PrismaClient({log:["error"]});e.s(["default",0,s])},32932,e=>{"use strict";var t=e.i(86687),s=e.i(68105);async function i(e){try{let i=e.headers.get("authorization");if(!i||!i.startsWith("Bearer "))return null;let r=i.substring(7),a=(0,t.verifyToken)(r),n=await (0,s.getUserById)(a.userId);if(!n||!n.isActive)return null;let d=n.roles.map(e=>e.role?.name||(e.customRole?`CUSTOM:${e.customRole.name}`:null)).filter(e=>null!==e),u=d.includes("GLOBAL_ADMIN");return{user:{id:n.id,email:n.email,roles:d,organizationId:n.organizationId||void 0,isGlobalAdmin:u},organizationId:n.organizationId||void 0}}catch(e){return null}}function r(e){if(!e)throw Error("Unauthorized")}function a(e,t){if(r(e),!e.user.roles.includes(t))throw Error("Forbidden: Insufficient permissions")}function n(e,t){if(r(e),!t.some(t=>e.user.roles.includes(t)))throw Error("Forbidden: Insufficient permissions")}e.s(["getAuthContext",()=>i,"requireAnyRole",()=>n,"requireAuth",()=>r,"requireRole",()=>a])},6461,(e,t,s)=>{t.exports=e.x("zlib",()=>require("zlib"))},27699,(e,t,s)=>{t.exports=e.x("events",()=>require("events"))},24836,(e,t,s)=>{t.exports=e.x("https",()=>require("https"))},21517,(e,t,s)=>{t.exports=e.x("http",()=>require("http"))},4446,(e,t,s)=>{t.exports=e.x("net",()=>require("net"))},55004,(e,t,s)=>{t.exports=e.x("tls",()=>require("tls"))},92509,(e,t,s)=>{t.exports=e.x("url",()=>require("url"))},86682,e=>{"use strict";var t=e.i(15270),s=e.i(29173),i=e.i(73421),r=e.i(89610);async function a(){let e=new Date().getFullYear(),t=Math.floor(9e3*Math.random())+1e3;return`TKT-${e}-${t.toString().padStart(4,"0")}`}async function n(n){let d=await a();if(!n.requesterId&&(!n.requesterEmail||!n.requesterName))throw Error("Either requesterId or requesterEmail/requesterName must be provided");let u=await t.default.ticket.create({data:{ticketNumber:d,subject:n.subject,description:n.description,requesterId:n.requesterId||null,requesterEmail:n.requesterEmail||null,requesterName:n.requesterName||null,publicTokenId:n.publicTokenId||null,assigneeId:n.assigneeId||null,tenantId:n.tenantId||null,organizationId:n.organizationId||null,category:n.category||null,customFields:n.customFields?n.customFields:null,priority:n.priority??s.TicketPriority.MEDIUM,status:s.TicketStatus.NEW},include:{requester:!!n.requesterId&&{select:{id:!0,email:!0,firstName:!0,lastName:!0}},assignee:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},tenant:{select:{id:!0,name:!0,slug:!0}}}});i.wsServer.broadcastToAll("ticket:created",{ticket:{id:u.id,ticketNumber:u.ticketNumber,subject:u.subject,status:u.status,priority:u.priority,requester:u.requester||{email:u.requesterEmail||"",name:u.requesterName||""},assignee:u.assignee,createdAt:u.createdAt}});let o=u;if(!u.assigneeId&&n.tenantId&&n.category){let{routeTicketByCategory:s,assignTicketToAgent:i}=await e.A(28642),r=await s({ticketId:u.id,tenantId:n.tenantId,category:n.category});if(r){await i(u.id,r);let e=await t.default.ticket.findUnique({where:{id:u.id},include:{requester:!!n.requesterId&&{select:{id:!0,email:!0,firstName:!0,lastName:!0}},assignee:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},tenant:{select:{id:!0,name:!0,slug:!0}}}});e&&(o=e)}}return o.assigneeId&&await (0,r.notifyTicketCreated)(o.id,o.ticketNumber,o.assigneeId),o}async function d(s){let i=s?.page||1,r=s?.limit||50,a=s?.sortBy||"createdAt",n=s?.sortOrder||"desc",d={};if(s?.status&&(d.status=s.status),s?.excludeStatuses&&s.excludeStatuses.length>0&&(d.status={notIn:s.excludeStatuses}),s?.assigneeId&&(d.assigneeId=s.assigneeId),s?.onlyAssignedToMe&&s?.userId&&(d.assigneeId=s.userId),s?.excludeAssignedToOthers&&s?.userId&&(d.OR=[{assigneeId:s.userId},{assigneeId:null}]),s?.priority&&(d.priority=s.priority),s?.requesterId&&(d.requesterId=s.requesterId),s?.publicTokenId&&(d.publicTokenId=s.publicTokenId),s?.tenantId&&(d.tenantId=s.tenantId),s?.category&&(d.category=s.category),s?.search){let e=s.search.trim();d.OR=[{subject:{contains:e,mode:"insensitive"}},{description:{contains:e,mode:"insensitive"}},{requesterEmail:{contains:e,mode:"insensitive"}},{requesterName:{contains:e,mode:"insensitive"}},{requester:{OR:[{email:{contains:e,mode:"insensitive"}},{firstName:{contains:e,mode:"insensitive"}},{lastName:{contains:e,mode:"insensitive"}}]}}]}if(s?.userId&&s?.userRoles&&!s.userRoles.includes("GLOBAL_ADMIN")){let e=await t.default.user.findUnique({where:{id:s.userId},select:{organizationId:!0}});if(!e?.organizationId)return{tickets:[],pagination:{page:i,limit:r,total:0,totalPages:0}};d.organizationId=e.organizationId}if(s?.organizationId&&(d.organizationId=s.organizationId),s?.userId&&s?.userRoles&&s.userRoles.some(e=>["AGENT","IT_MANAGER"].includes(e))&&!s.userRoles.includes("GLOBAL_ADMIN")&&!s.userRoles.includes("ADMIN")){let{getUserAssignedCategories:t}=await e.A(7412),a=await t(s.userId);if(!(a.size>0))return{tickets:[],pagination:{page:i,limit:r,total:0,totalPages:0}};{let e=[];if(a.forEach((t,s)=>{t.size>0&&e.push({tenantId:s,category:{in:Array.from(t)}})}),!(e.length>0))return{tickets:[],pagination:{page:i,limit:r,total:0,totalPages:0}};if(d.OR&&Array.isArray(d.OR)){let t=d.OR;delete d.OR,d.AND=[{OR:t},{OR:e}]}else d.OR||(d.OR=e)}}if(s?.excludeAssignedToOthers&&s?.userId){let e={OR:[{assigneeId:s.userId},{assigneeId:null}]};if(d.AND)d.AND.push(e);else if(d.OR&&Array.isArray(d.OR)){let t=d.OR;delete d.OR,d.AND=[{OR:t},e]}else d.AND=[e]}Object.keys(d).forEach(e=>{void 0===d[e]&&delete d[e]});let u={};u[["createdAt","updatedAt","ticketNumber","subject","status","priority"].includes(a)?a:"createdAt"]=n;let[o,l]=await Promise.all([t.default.ticket.findMany({where:d,orderBy:u,skip:(i-1)*r,take:r,include:{requester:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},assignee:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},tenant:{select:{id:!0,name:!0,slug:!0}}}}),t.default.ticket.count({where:d})]);return{tickets:o,pagination:{page:i,limit:r,total:l,totalPages:Math.ceil(l/r)}}}async function u(e){return t.default.ticket.findUnique({where:{id:e},include:{requester:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},assignee:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},tenant:{select:{id:!0,name:!0,slug:!0}},escalatedByUser:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},escalatedToCustomRole:{select:{id:!0,name:!0,displayName:!0}},comments:{orderBy:{createdAt:"asc"},include:{author:{select:{id:!0,email:!0,firstName:!0,lastName:!0}}}}}})}async function o(e,a){let n=await t.default.ticket.findUnique({where:{id:e},include:{requester:{select:{id:!0}},assignee:{select:{id:!0}}}});if(!n)throw Error("Ticket not found");let d=await t.default.ticket.update({where:{id:e},data:{subject:a.subject,description:a.description,status:a.status,priority:a.priority,assigneeId:a.assigneeId,closedAt:a.status===s.TicketStatus.CLOSED?new Date:void 0},include:{requester:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},assignee:{select:{id:!0,email:!0,firstName:!0,lastName:!0}}}}),u={};a.status&&a.status!==n.status&&(u.status={from:n.status,to:a.status}),a.priority&&a.priority!==n.priority&&(u.priority={from:n.priority,to:a.priority}),void 0!==a.assigneeId&&a.assigneeId!==n.assigneeId&&(u.assigneeId={from:n.assigneeId,to:a.assigneeId}),i.wsServer.broadcastToTicketSubscribers(e,"ticket:updated",{ticket:{id:d.id,ticketNumber:d.ticketNumber,subject:d.subject,status:d.status,priority:d.priority,requester:d.requester,assignee:d.assignee,updatedAt:d.updatedAt},changes:u});let o=[];return d.requesterId&&o.push(d.requesterId),d.assigneeId&&o.push(d.assigneeId),n.requesterId&&!o.includes(n.requesterId)&&o.push(n.requesterId),n.assigneeId&&!o.includes(n.assigneeId)&&o.push(n.assigneeId),Object.keys(u).length>0&&o.length>0&&await (0,r.notifyTicketUpdated)(d.id,d.ticketNumber,u,o),void 0!==a.assigneeId&&a.assigneeId!==n.assigneeId&&a.assigneeId&&(await (0,r.notifyTicketAssigned)(d.id,d.ticketNumber,a.assigneeId),i.wsServer.broadcastToUser(a.assigneeId,"ticket:assigned",{ticket:{id:d.id,ticketNumber:d.ticketNumber,subject:d.subject}})),d}async function l(e){let s=await t.default.ticket.findUnique({where:{id:e.ticketId},include:{requester:{select:{id:!0}},assignee:{select:{id:!0}},comments:{select:{authorId:!0},distinct:["authorId"]}}});if(!s)throw Error("Ticket not found");let a=await t.default.ticketComment.create({data:{ticketId:e.ticketId,authorId:e.authorId,body:e.body},include:{author:{select:{id:!0,email:!0,firstName:!0,lastName:!0}}}});i.wsServer.broadcastToTicketSubscribers(e.ticketId,"ticket:comment",{ticketId:e.ticketId,comment:{id:a.id,body:a.body,author:a.author,createdAt:a.createdAt}});let n=[];return s.requesterId&&n.push(s.requesterId),s.assigneeId&&n.push(s.assigneeId),s.comments.forEach(e=>{e.authorId&&!n.includes(e.authorId)&&n.push(e.authorId)}),n.length>0&&await (0,r.notifyTicketComment)(e.ticketId,s.ticketNumber,e.authorId,n),a}async function c(e,s){return(await t.default.ticket.updateMany({where:{publicTokenId:e,requesterId:null},data:{requesterId:s,publicTokenId:null}})).count}e.s(["addTicketComment",()=>l,"createTicket",()=>n,"generateTicketNumber",()=>a,"getTicketById",()=>u,"listTickets",()=>d,"mergePublicTokenTicketsToUser",()=>c,"updateTicket",()=>o])},39388,e=>{"use strict";var t=e.i(15270),s=e.i(29173);async function i(i){let r=await t.default.knowledgeBaseArticle.create({data:{title:i.title,content:i.content,slug:i.slug,tags:i.tags??[],status:i.status??s.ArticleStatus.PUBLISHED,organizationId:i.organizationId||null}});return null!==i.tenantIds&&i.tenantIds&&i.tenantIds.length>0&&await t.default.tenantKBArticle.createMany({data:i.tenantIds.map(e=>({tenantId:e,articleId:r.id})),skipDuplicates:!0}),r.status===s.ArticleStatus.PUBLISHED&&e.A(31223).then(({generateArticleEmbeddings:e})=>e(r.id)).catch(e=>console.error("Failed to generate embeddings:",e)),r}async function r(i,r){let a=await t.default.knowledgeBaseArticle.update({where:{id:i},data:{title:r.title,content:r.content,tags:r.tags,status:r.status}});return void 0!==r.tenantIds&&(await t.default.tenantKBArticle.deleteMany({where:{articleId:i}}),null!==r.tenantIds&&r.tenantIds.length>0&&await t.default.tenantKBArticle.createMany({data:r.tenantIds.map(e=>({tenantId:e,articleId:i})),skipDuplicates:!0})),a.status===s.ArticleStatus.PUBLISHED&&e.A(31223).then(({generateArticleEmbeddings:e})=>e(a.id)).catch(e=>console.error("Failed to regenerate embeddings:",e)),a}async function a(e){return t.default.knowledgeBaseArticle.findUnique({where:{id:e}})}async function n(e){let s={status:e?.status,tags:e?.tag?{has:e.tag}:void 0};if(e?.userId&&e?.userRoles&&!e.userRoles.includes("GLOBAL_ADMIN")){let i=await t.default.user.findUnique({where:{id:e.userId},select:{organizationId:!0}});if(!i?.organizationId)return[];s.organizationId=i.organizationId}return e?.organizationId&&(s.organizationId=e.organizationId),e?.tenantId&&(s.tenantKBArticles={some:{tenantId:e.tenantId}}),t.default.knowledgeBaseArticle.findMany({where:s,orderBy:{createdAt:"desc"}})}async function d(i,r,a){if(!i.trim())return[];if(a?.useSemanticSearch!==!1)try{let{semanticSearchArticles:t}=await e.A(31223);return await t(i,{tenantId:r,organizationId:a?.organizationId,userId:a?.userId,userRoles:a?.userRoles,limit:10})}catch(e){console.error("Semantic search failed, falling back to text search:",e)}let n=i.toLowerCase(),d={OR:[{title:{contains:n,mode:"insensitive"}},{content:{contains:n,mode:"insensitive"}},{tags:{has:i}}],status:s.ArticleStatus.PUBLISHED};return r&&(d.tenantKBArticles={some:{tenantId:r}}),a?.organizationId&&!a.userRoles?.includes("GLOBAL_ADMIN")&&(d.organizationId=a.organizationId),t.default.knowledgeBaseArticle.findMany({where:d,orderBy:{createdAt:"desc"},take:10})}e.s(["createArticle",()=>i,"getArticleById",()=>a,"listArticles",()=>n,"searchArticles",()=>d,"updateArticle",()=>r])},50050,e=>{"use strict";var t=e.i(15270);async function s(e){let s=await t.default.chatConversation.findFirst({where:{userId:e},orderBy:{updatedAt:"desc"}});return s||t.default.chatConversation.create({data:{userId:e}})}async function i(e,s,i,r,a){return t.default.chatMessage.create({data:{conversationId:e,role:s,content:i,toolCalls:r?JSON.parse(JSON.stringify(r)):null,toolCallId:a}})}async function r(e){return t.default.chatConversation.findMany({where:{userId:e},orderBy:{updatedAt:"desc"},include:{messages:{orderBy:{createdAt:"asc"},take:1}}})}async function a(e,s){await t.default.chatConversation.deleteMany({where:{id:e,userId:s}})}e.s(["deleteConversation",()=>a,"getOrCreateConversation",()=>s,"getUserConversations",()=>r,"saveMessage",()=>i])},31223,e=>{e.v(t=>Promise.all(["server/chunks/lib_services_embedding-service_ts_5aa12106._.js"].map(t=>e.l(t))).then(()=>t(72921)))},28642,e=>{e.v(t=>Promise.all(["server/chunks/lib_services_ticket-routing-service_ts_1e1adca9._.js"].map(t=>e.l(t))).then(()=>t(43887)))},7412,e=>{e.v(t=>Promise.all(["server/chunks/lib_services_tenant-service_ts_e0fbdcc5._.js"].map(t=>e.l(t))).then(()=>t(16766)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__1805f9bc._.js.map