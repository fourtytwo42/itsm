module.exports=[6461,(e,t,s)=>{t.exports=e.x("zlib",()=>require("zlib"))},27699,(e,t,s)=>{t.exports=e.x("events",()=>require("events"))},24836,(e,t,s)=>{t.exports=e.x("https",()=>require("https"))},21517,(e,t,s)=>{t.exports=e.x("http",()=>require("http"))},4446,(e,t,s)=>{t.exports=e.x("net",()=>require("net"))},55004,(e,t,s)=>{t.exports=e.x("tls",()=>require("tls"))},92509,(e,t,s)=>{t.exports=e.x("url",()=>require("url"))},86682,e=>{"use strict";var t=e.i(15270),s=e.i(29173),i=e.i(73421),a=e.i(89610);async function r(){let e=new Date().getFullYear(),t=Math.floor(9e3*Math.random())+1e3;return`TKT-${e}-${t.toString().padStart(4,"0")}`}async function n(n){let d=await r();if(!n.requesterId&&(!n.requesterEmail||!n.requesterName))throw Error("Either requesterId or requesterEmail/requesterName must be provided");let u=await t.default.ticket.create({data:{ticketNumber:d,subject:n.subject,description:n.description,requesterId:n.requesterId||null,requesterEmail:n.requesterEmail||null,requesterName:n.requesterName||null,publicTokenId:n.publicTokenId||null,assigneeId:n.assigneeId||null,tenantId:n.tenantId||null,organizationId:n.organizationId||null,category:n.category||null,customFields:n.customFields?n.customFields:null,priority:n.priority??s.TicketPriority.MEDIUM,status:s.TicketStatus.NEW},include:{requester:!!n.requesterId&&{select:{id:!0,email:!0,firstName:!0,lastName:!0}},assignee:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},tenant:{select:{id:!0,name:!0,slug:!0}}}});i.wsServer.broadcastToAll("ticket:created",{ticket:{id:u.id,ticketNumber:u.ticketNumber,subject:u.subject,status:u.status,priority:u.priority,requester:u.requester||{email:u.requesterEmail||"",name:u.requesterName||""},assignee:u.assignee,createdAt:u.createdAt}});let c=u;if(!u.assigneeId&&n.tenantId&&n.category){let{routeTicketByCategory:s,assignTicketToAgent:i}=await e.A(28642),a=await s({ticketId:u.id,tenantId:n.tenantId,category:n.category});if(a){await i(u.id,a);let e=await t.default.ticket.findUnique({where:{id:u.id},include:{requester:!!n.requesterId&&{select:{id:!0,email:!0,firstName:!0,lastName:!0}},assignee:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},tenant:{select:{id:!0,name:!0,slug:!0}}}});e&&(c=e)}}return c.assigneeId&&await (0,a.notifyTicketCreated)(c.id,c.ticketNumber,c.assigneeId),c}async function d(s){let i=s?.page||1,a=s?.limit||50,r=s?.sortBy||"createdAt",n=s?.sortOrder||"desc",d={};if(s?.status&&(d.status=s.status),s?.excludeStatuses&&s.excludeStatuses.length>0&&(d.status={notIn:s.excludeStatuses}),s?.assigneeId&&(d.assigneeId=s.assigneeId),s?.onlyAssignedToMe&&s?.userId&&(d.assigneeId=s.userId),s?.excludeAssignedToOthers&&s?.userId&&(d.OR=[{assigneeId:s.userId},{assigneeId:null}]),s?.priority&&(d.priority=s.priority),s?.requesterId&&(d.requesterId=s.requesterId),s?.publicTokenId&&(d.publicTokenId=s.publicTokenId),s?.tenantId&&(d.tenantId=s.tenantId),s?.category&&(d.category=s.category),s?.search){let e=s.search.trim();d.OR=[{subject:{contains:e,mode:"insensitive"}},{description:{contains:e,mode:"insensitive"}},{requesterEmail:{contains:e,mode:"insensitive"}},{requesterName:{contains:e,mode:"insensitive"}},{requester:{OR:[{email:{contains:e,mode:"insensitive"}},{firstName:{contains:e,mode:"insensitive"}},{lastName:{contains:e,mode:"insensitive"}}]}}]}if(s?.userId&&s?.userRoles&&!s.userRoles.includes("GLOBAL_ADMIN")){let e=await t.default.user.findUnique({where:{id:s.userId},select:{organizationId:!0}});if(!e?.organizationId)return{tickets:[],pagination:{page:i,limit:a,total:0,totalPages:0}};d.organizationId=e.organizationId}if(s?.organizationId&&(d.organizationId=s.organizationId),s?.userId&&s?.userRoles&&s.userRoles.some(e=>["AGENT","IT_MANAGER"].includes(e))&&!s.userRoles.includes("GLOBAL_ADMIN")&&!s.userRoles.includes("ADMIN")){let{getUserAssignedCategories:t}=await e.A(7412),r=await t(s.userId);if(!(r.size>0))return{tickets:[],pagination:{page:i,limit:a,total:0,totalPages:0}};{let e=[];if(r.forEach((t,s)=>{t.size>0&&e.push({tenantId:s,category:{in:Array.from(t)}})}),!(e.length>0))return{tickets:[],pagination:{page:i,limit:a,total:0,totalPages:0}};if(d.OR&&Array.isArray(d.OR)){let t=d.OR;delete d.OR,d.AND=[{OR:t},{OR:e}]}else d.OR||(d.OR=e)}}if(s?.excludeAssignedToOthers&&s?.userId){let e={OR:[{assigneeId:s.userId},{assigneeId:null}]};if(d.AND)d.AND.push(e);else if(d.OR&&Array.isArray(d.OR)){let t=d.OR;delete d.OR,d.AND=[{OR:t},e]}else d.AND=[e]}Object.keys(d).forEach(e=>{void 0===d[e]&&delete d[e]});let u={};u[["createdAt","updatedAt","ticketNumber","subject","status","priority"].includes(r)?r:"createdAt"]=n;let[c,l]=await Promise.all([t.default.ticket.findMany({where:d,orderBy:u,skip:(i-1)*a,take:a,include:{requester:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},assignee:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},tenant:{select:{id:!0,name:!0,slug:!0}}}}),t.default.ticket.count({where:d})]);return{tickets:c,pagination:{page:i,limit:a,total:l,totalPages:Math.ceil(l/a)}}}async function u(e){return t.default.ticket.findUnique({where:{id:e},include:{requester:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},assignee:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},tenant:{select:{id:!0,name:!0,slug:!0}},comments:{orderBy:{createdAt:"asc"},include:{author:{select:{id:!0,email:!0,firstName:!0,lastName:!0}}}}}})}async function c(e,r){let n=await t.default.ticket.findUnique({where:{id:e},include:{requester:{select:{id:!0}},assignee:{select:{id:!0}}}});if(!n)throw Error("Ticket not found");let d=await t.default.ticket.update({where:{id:e},data:{subject:r.subject,description:r.description,status:r.status,priority:r.priority,assigneeId:r.assigneeId,closedAt:r.status===s.TicketStatus.CLOSED?new Date:void 0},include:{requester:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},assignee:{select:{id:!0,email:!0,firstName:!0,lastName:!0}}}}),u={};r.status&&r.status!==n.status&&(u.status={from:n.status,to:r.status}),r.priority&&r.priority!==n.priority&&(u.priority={from:n.priority,to:r.priority}),void 0!==r.assigneeId&&r.assigneeId!==n.assigneeId&&(u.assigneeId={from:n.assigneeId,to:r.assigneeId}),i.wsServer.broadcastToTicketSubscribers(e,"ticket:updated",{ticket:{id:d.id,ticketNumber:d.ticketNumber,subject:d.subject,status:d.status,priority:d.priority,requester:d.requester,assignee:d.assignee,updatedAt:d.updatedAt},changes:u});let c=[];return d.requesterId&&c.push(d.requesterId),d.assigneeId&&c.push(d.assigneeId),n.requesterId&&!c.includes(n.requesterId)&&c.push(n.requesterId),n.assigneeId&&!c.includes(n.assigneeId)&&c.push(n.assigneeId),Object.keys(u).length>0&&c.length>0&&await (0,a.notifyTicketUpdated)(d.id,d.ticketNumber,u,c),void 0!==r.assigneeId&&r.assigneeId!==n.assigneeId&&r.assigneeId&&(await (0,a.notifyTicketAssigned)(d.id,d.ticketNumber,r.assigneeId),i.wsServer.broadcastToUser(r.assigneeId,"ticket:assigned",{ticket:{id:d.id,ticketNumber:d.ticketNumber,subject:d.subject}})),d}async function l(e){let s=await t.default.ticket.findUnique({where:{id:e.ticketId},include:{requester:{select:{id:!0}},assignee:{select:{id:!0}},comments:{select:{authorId:!0},distinct:["authorId"]}}});if(!s)throw Error("Ticket not found");let r=await t.default.ticketComment.create({data:{ticketId:e.ticketId,authorId:e.authorId,body:e.body},include:{author:{select:{id:!0,email:!0,firstName:!0,lastName:!0}}}});i.wsServer.broadcastToTicketSubscribers(e.ticketId,"ticket:comment",{ticketId:e.ticketId,comment:{id:r.id,body:r.body,author:r.author,createdAt:r.createdAt}});let n=[];return s.requesterId&&n.push(s.requesterId),s.assigneeId&&n.push(s.assigneeId),s.comments.forEach(e=>{e.authorId&&!n.includes(e.authorId)&&n.push(e.authorId)}),n.length>0&&await (0,a.notifyTicketComment)(e.ticketId,s.ticketNumber,e.authorId,n),r}async function o(e,s){return(await t.default.ticket.updateMany({where:{publicTokenId:e,requesterId:null},data:{requesterId:s,publicTokenId:null}})).count}e.s(["addTicketComment",()=>l,"createTicket",()=>n,"generateTicketNumber",()=>r,"getTicketById",()=>u,"listTickets",()=>d,"mergePublicTokenTicketsToUser",()=>o,"updateTicket",()=>c])},28642,e=>{e.v(t=>Promise.all(["server/chunks/lib_services_ticket-routing-service_ts_1e1adca9._.js"].map(t=>e.l(t))).then(()=>t(43887)))},7412,e=>{e.v(t=>Promise.all(["server/chunks/lib_services_tenant-service_ts_e0fbdcc5._.js"].map(t=>e.l(t))).then(()=>t(16766)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__70fe9959._.js.map