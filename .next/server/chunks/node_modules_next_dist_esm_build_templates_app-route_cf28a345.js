module.exports=[351,e=>{"use strict";var t=e.i(47909),a=e.i(74017),s=e.i(96250),o=e.i(59756),r=e.i(61916),n=e.i(14444),i=e.i(37092),l=e.i(69741),d=e.i(16795),c=e.i(87718),u=e.i(95169),R=e.i(47587),p=e.i(66012),m=e.i(70101),T=e.i(26937),N=e.i(10372),I=e.i(93695);e.i(52474);var f=e.i(220),g=e.i(89171),h=e.i(32932),E=e.i(15270),A=e.i(22366),w=e.i(35683),v=e.i(43934),y=e.i(29173),U=e.i(66991);let x=U.z.object({escalatedToRoleId:U.z.string().uuid().optional(),escalatedToSystemRole:U.z.nativeEnum(y.RoleName).optional(),escalatedToUserId:U.z.string().uuid().optional(),escalationNote:U.z.string().optional()});async function O(e,{params:t}){try{let a=await (0,h.getAuthContext)(e);if((0,h.requireAuth)(a),!a.user.organizationId)return g.NextResponse.json({success:!1,error:{code:"BAD_REQUEST",message:"User must belong to an organization"}},{status:400});let s=await E.default.ticket.findUnique({where:{id:(await t).id},select:{tenantId:!0,organizationId:!0}});if(!s||s.organizationId!==a.user.organizationId)return g.NextResponse.json({success:!1,error:{code:"NOT_FOUND",message:"Ticket not found"}},{status:404});let[o,r]=await Promise.all([(0,A.getAvailableRolesForEscalation)(a.user.organizationId),(0,A.getAvailableUsersForEscalation)(a.user.organizationId,s.tenantId)]);return g.NextResponse.json({success:!0,data:{availableRoles:o,availableUsers:r}})}catch(e){return console.error("Get escalation roles error:",e),g.NextResponse.json({success:!1,error:{code:"INTERNAL_ERROR",message:e instanceof Error?e.message:"An unexpected error occurred"}},{status:500})}}async function C(e,{params:t}){try{let a=await (0,h.getAuthContext)(e);if((0,h.requireAuth)(a),!a.user.roles.some(e=>"AGENT"===e||"IT_MANAGER"===e||"ADMIN"===e||e.startsWith("CUSTOM:")))return g.NextResponse.json({success:!1,error:{code:"FORBIDDEN",message:"Only agents and above can escalate tickets"}},{status:403});let{id:s}=await t,o=await e.json(),r=x.parse(o),n=r.escalatedToRoleId||r.escalatedToSystemRole,i=!!r.escalatedToUserId;if(!n&&!i)return g.NextResponse.json({success:!1,error:{code:"VALIDATION_ERROR",message:"Must provide either escalatedToRoleId, escalatedToSystemRole, or escalatedToUserId"}},{status:400});if([r.escalatedToRoleId,r.escalatedToSystemRole,r.escalatedToUserId].filter(Boolean).length>1)return g.NextResponse.json({success:!1,error:{code:"VALIDATION_ERROR",message:"Can only provide one escalation target (role or user)"}},{status:400});let l=await E.default.ticket.findUnique({where:{id:s},include:{organization:!0}});if(!l)return g.NextResponse.json({success:!1,error:{code:"NOT_FOUND",message:"Ticket not found"}},{status:404});if(l.organizationId!==a.user.organizationId)return g.NextResponse.json({success:!1,error:{code:"FORBIDDEN",message:"Access denied"}},{status:403});if(r.escalatedToRoleId){let e=await E.default.customRole.findUnique({where:{id:r.escalatedToRoleId}});if(!e||e.organizationId!==a.user.organizationId)return g.NextResponse.json({success:!1,error:{code:"NOT_FOUND",message:"Custom role not found"}},{status:404})}if(r.escalatedToSystemRole&&(r.escalatedToSystemRole===y.RoleName.ADMIN||r.escalatedToSystemRole===y.RoleName.END_USER))return g.NextResponse.json({success:!1,error:{code:"VALIDATION_ERROR",message:"Cannot escalate to ADMIN or END_USER roles"}},{status:400});if(r.escalatedToUserId){let e=await E.default.user.findUnique({where:{id:r.escalatedToUserId},include:{roles:{include:{role:!0,customRole:!0}}}});if(!e||e.organizationId!==a.user.organizationId)return g.NextResponse.json({success:!1,error:{code:"NOT_FOUND",message:"User not found"}},{status:404});let t=e.roles.map(e=>e.role?.name||(e.customRole?`CUSTOM:${e.customRole.name}`:null)).filter(e=>null!==e);if(t.includes("ADMIN")||t.includes("END_USER"))return g.NextResponse.json({success:!1,error:{code:"VALIDATION_ERROR",message:"Cannot escalate to ADMIN or END_USER"}},{status:400});if(l.tenantId&&!await E.default.tenantAssignment.findFirst({where:{userId:r.escalatedToUserId,tenantId:l.tenantId,category:null}}))return g.NextResponse.json({success:!1,error:{code:"VALIDATION_ERROR",message:"User is not assigned to this ticket's tenant"}},{status:400})}let d="";if(r.escalatedToUserId){let e=await E.default.user.findUnique({where:{id:r.escalatedToUserId},select:{email:!0,firstName:!0,lastName:!0}});d=e?`${e.firstName||""} ${e.lastName||""}`.trim()||e.email:"Unknown User"}else if(r.escalatedToRoleId){let e=await E.default.customRole.findUnique({where:{id:r.escalatedToRoleId},select:{displayName:!0}});d=e?.displayName||"Unknown Role"}else r.escalatedToSystemRole&&(d=r.escalatedToSystemRole.replace("_"," "));let c=await E.default.ticket.update({where:{id:s},data:{escalatedToRoleId:r.escalatedToRoleId||null,escalatedToSystemRole:r.escalatedToSystemRole||null,escalatedToUserId:r.escalatedToUserId||null,escalatedAt:new Date,escalatedBy:a.user.id,escalationNote:r.escalationNote||null},include:{escalatedByUser:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},escalatedToUser:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},escalatedToCustomRole:{select:{id:!0,name:!0,displayName:!0}}}});return await (0,w.createTicketHistory)({ticketId:s,type:y.TicketHistoryType.ESCALATED,userId:a.user.id,oldValue:l.assigneeId?"Assigned":"Unassigned",newValue:d,note:r.escalationNote||null,metadata:{escalatedToRoleId:r.escalatedToRoleId,escalatedToSystemRole:r.escalatedToSystemRole,escalatedToUserId:r.escalatedToUserId}}),await (0,v.auditLog)(y.AuditEventType.TICKET_ESCALATED,"Ticket",l.id,a.user.id,a.user.email,`Escalated ticket to ${d}`,{ticketId:l.id,escalatedToRoleId:r.escalatedToRoleId,escalatedToSystemRole:r.escalatedToSystemRole,escalatedToUserId:r.escalatedToUserId,escalationNote:r.escalationNote},e),g.NextResponse.json({success:!0,data:{ticket:c}})}catch(e){if(e instanceof U.z.ZodError)return g.NextResponse.json({success:!1,error:{code:"VALIDATION_ERROR",message:"Invalid input data",details:e.errors}},{status:400});return console.error("Escalate ticket error:",e),g.NextResponse.json({success:!1,error:{code:"INTERNAL_ERROR",message:e instanceof Error?e.message:"An unexpected error occurred"}},{status:500})}}e.s(["GET",()=>O,"POST",()=>C],87496);var S=e.i(87496);let D=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/v1/tickets/[id]/escalate/route",pathname:"/api/v1/tickets/[id]/escalate",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/v1/tickets/[id]/escalate/route.ts",nextConfigOutput:"",userland:S}),{workAsyncStorage:_,workUnitAsyncStorage:k,serverHooks:b}=D;function j(){return(0,s.patchFetch)({workAsyncStorage:_,workUnitAsyncStorage:k})}async function M(e,t,s){D.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let g="/api/v1/tickets/[id]/escalate/route";g=g.replace(/\/index$/,"")||"/";let h=await D.prepare(e,t,{srcPage:g,multiZoneDraftMode:!1});if(!h)return t.statusCode=400,t.end("Bad Request"),null==s.waitUntil||s.waitUntil.call(s,Promise.resolve()),null;let{buildId:E,params:A,nextConfig:w,parsedUrl:v,isDraftMode:y,prerenderManifest:U,routerServerContext:x,isOnDemandRevalidate:O,revalidateOnlyGenerated:C,resolvedPathname:S,clientReferenceManifest:_,serverActionsManifest:k}=h,b=(0,l.normalizeAppPath)(g),j=!!(U.dynamicRoutes[b]||U.routes[S]),M=async()=>((null==x?void 0:x.render404)?await x.render404(e,t,v,!1):t.end("This page could not be found"),null);if(j&&!y){let e=!!U.routes[S],t=U.dynamicRoutes[b];if(t&&!1===t.fallback&&!e){if(w.experimental.adapterPath)return await M();throw new I.NoFallbackError}}let P=null;!j||D.isDev||y||(P="/index"===(P=S)?"/":P);let q=!0===D.isDev||!j,z=j&&!q;k&&_&&(0,n.setReferenceManifestsSingleton)({page:g,clientReferenceManifest:_,serverActionsManifest:k,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:k})});let H=e.method||"GET",F=(0,r.getTracer)(),L=F.getActiveScopeSpan(),$={params:A,prerenderManifest:U,renderOpts:{experimental:{authInterrupts:!!w.experimental.authInterrupts},cacheComponents:!!w.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:w.cacheLife,waitUntil:s.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,s)=>D.onRequestError(e,t,s,x)},sharedContext:{buildId:E}},B=new d.NodeNextRequest(e),V=new d.NodeNextResponse(t),K=c.NextRequestAdapter.fromNodeNextRequest(B,(0,c.signalFromNodeResponse)(t));try{let n=async e=>D.handle(K,$).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=F.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=a.get("next.route");if(s){let t=`${H} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${g}`)}),i=!!(0,o.getRequestMeta)(e,"minimalMode"),l=async o=>{var r,l;let d=async({previousCacheEntry:a})=>{try{if(!i&&O&&C&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await n(o);e.fetchMetrics=$.renderOpts.fetchMetrics;let l=$.renderOpts.pendingWaitUntil;l&&s.waitUntil&&(s.waitUntil(l),l=void 0);let d=$.renderOpts.collectedTags;if(!j)return await (0,p.sendResponse)(B,V,r,$.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(r.headers);d&&(t[N.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=N.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,s=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=N.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:s}}}}catch(t){throw(null==a?void 0:a.isStale)&&await D.onRequestError(e,t,{routerKind:"App Router",routePath:g,routeType:"route",revalidateReason:(0,R.getRevalidateReason)({isStaticGeneration:z,isOnDemandRevalidate:O})},x),t}},c=await D.handleResponse({req:e,nextConfig:w,cacheKey:P,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:U,isRoutePPREnabled:!1,isOnDemandRevalidate:O,revalidateOnlyGenerated:C,responseGenerator:d,waitUntil:s.waitUntil,isMinimalMode:i});if(!j)return null;if((null==c||null==(r=c.value)?void 0:r.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",O?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),y&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,m.fromNodeOutgoingHttpHeaders)(c.value.headers);return i&&j||u.delete(N.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,T.getCacheControlHeader)(c.cacheControl)),await (0,p.sendResponse)(B,V,new Response(c.value.body,{headers:u,status:c.value.status||200})),null};L?await l(L):await F.withPropagatedContext(e.headers,()=>F.trace(u.BaseServerSpan.handleRequest,{spanName:`${H} ${g}`,kind:r.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},l))}catch(t){if(t instanceof I.NoFallbackError||await D.onRequestError(e,t,{routerKind:"App Router",routePath:b,routeType:"route",revalidateReason:(0,R.getRevalidateReason)({isStaticGeneration:z,isOnDemandRevalidate:O})}),j)throw t;return await (0,p.sendResponse)(B,V,new Response(null,{status:500})),null}}e.s(["handler",()=>M,"patchFetch",()=>j,"routeModule",()=>D,"serverHooks",()=>b,"workAsyncStorage",()=>_,"workUnitAsyncStorage",()=>k],351)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_cf28a345.js.map