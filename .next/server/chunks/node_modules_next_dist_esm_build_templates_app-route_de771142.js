module.exports=[48206,e=>{"use strict";var t=e.i(47909),o=e.i(74017),s=e.i(96250),r=e.i(59756),a=e.i(61916),n=e.i(14444),i=e.i(37092),l=e.i(69741),c=e.i(16795),u=e.i(87718),d=e.i(95169),p=e.i(47587),h=e.i(66012),g=e.i(70101),m=e.i(74838),f=e.i(10372),y=e.i(93695);e.i(52474);var v=e.i(220),I=e.i(89171),R=e.i(39388),w=e.i(86682);let A="gpt-5-nano",C=`You are a friendly IT support assistant. Help users with any IT-related issues including:
- Device problems (laptops, desktops, mobile devices)
- Account access issues (locked out, password resets, login problems)
- Application/service access (can't access software, websites, or services)
- Network connectivity issues
- Software installation or configuration
- Email and communication tools
- General IT questions and requests

CONVERSATION RULES:
- Respond naturally to greetings and casual conversation
- Only search the knowledge base when a user describes a specific technical problem
- Only create tickets when: (1) KB search found no solutions AND (2) the issue requires hands-on IT support or cannot be resolved through self-service
- Don't jump to ticket creation - that's a last resort after trying to help directly

WHEN A USER REPORTS A PROBLEM:
1. First, automatically search the knowledge base using search_knowledge_base tool (don't ask permission, just search)
2. If KB articles are found, provide the solution directly based on those articles
3. If no KB solution exists and the problem needs hands-on support, THEN guide them to create a ticket by asking ONE question at a time to gather relevant details:
   - For device issues: "What device are you using?" then "What operating system?" then "What specific symptoms?"
   - For account/service issues: "Which service or account are you trying to access?" then "What error message do you see?"
   - Always ask: "What have you tried so far?" and "Is this blocking your work?" (for priority)
   Then create the ticket with create_ticket tool using all collected information.

Be friendly, conversational, and helpful. Don't assume all problems are device-related - listen to what the user is actually reporting.`;async function _(e){let t=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${function(){let e=process.env.OPENAI_API_KEY;if(!e)throw Error("OPENAI_API_KEY is not set");return e}()}`},body:JSON.stringify(e)});if(!t.ok){let e=await t.text();throw console.error("OpenAI API Error:",t.status,e),Error(`OpenAI API error: ${t.status} ${e}`)}return t.json()}async function E(e,t,o,s,r){let a=JSON.parse(e.function.arguments||"{}");if("search_knowledge_base"===e.function.name){let n=await (0,R.searchArticles)(a.query??"",o,{organizationId:s,userId:t,userRoles:r,useSemanticSearch:!0});return{tool_call_id:e.id,role:"tool",name:"search_knowledge_base",content:JSON.stringify(n)}}if("create_ticket"===e.function.name){if(!t)throw Error("Authentication required to create ticket");try{console.log("[AI Service] Creating ticket via tool call",{subject:a.subject?.substring(0,50),requesterId:t});let s=await (0,w.createTicket)({subject:a.subject,description:a.description,priority:a.priority||"MEDIUM",requesterId:t,tenantId:o});return console.log("[AI Service] Ticket created successfully",{ticketId:s.id,ticketNumber:s.ticketNumber}),{tool_call_id:e.id,role:"tool",name:"create_ticket",content:JSON.stringify({success:!0,ticketId:s.id,ticketNumber:s.ticketNumber,subject:s.subject,message:`Ticket ${s.ticketNumber} created successfully`})}}catch(t){return console.error("[AI Service] Error creating ticket via tool call",{error:t,args:a}),{tool_call_id:e.id,role:"tool",name:"create_ticket",content:JSON.stringify({success:!1,error:t instanceof Error?t.message:"Failed to create ticket"})}}}throw Error(`Unsupported tool: ${e.function.name}`)}async function b(e){let t=e.messages.map(e=>{let t={role:e.role,content:e.content};return e.name&&(t.name=e.name),e.tool_call_id&&(t.tool_call_id=e.tool_call_id),t});t.some(e=>"system"===e.role)||t.unshift({role:"system",content:C});let o=await _({model:A,messages:t,tools:[{type:"function",function:{name:"search_knowledge_base",description:"Automatically search the knowledge base to find solutions and troubleshooting steps for the user's issue. Always use this tool FIRST when a user reports a problem - search immediately and provide the solution directly.",parameters:{type:"object",properties:{query:{type:"string",description:"The search query based on the user's problem description. Extract key technical terms and symptoms."}},required:["query"]}}},{type:"function",function:{name:"create_ticket",description:"Create a support ticket when you cannot resolve the issue yourself. Only call this when: 1) KB search found no solutions, 2) The issue requires hands-on IT support, or 3) The user explicitly requests a ticket. Gather required information one piece at a time before calling this function.",parameters:{type:"object",properties:{subject:{type:"string",description:'Brief summary of the issue (e.g., "Laptop not booting - Dell XPS 13")'},description:{type:"string",description:"Detailed description including: device/model, OS, symptoms, what was tried, when it started"},priority:{type:"string",enum:["LOW","MEDIUM","HIGH","CRITICAL"],description:"LOW=non-urgent, MEDIUM=normal issue, HIGH=urgent/blocking work, CRITICAL=system outage/critical business impact"}},required:["subject","description"]}}}],tool_choice:"auto"}),s=o.choices[0]?.message;if(!s)throw Error("No response from OpenAI");if(!s.tool_calls||0===s.tool_calls.length)return{reply:s.content??"",toolCalls:[]};console.log("[AI Service] Processing tool calls",{toolCallCount:s.tool_calls.length,toolNames:s.tool_calls.map(e=>e.function.name)});let r=await Promise.all(s.tool_calls.map(t=>E(t,e.requesterId,e.tenantId,e.organizationId,e.userRoles)));console.log("[AI Service] Tool calls completed",{resultCount:r.length});let a=[...t,s,...r];console.log("[AI Service] Sending followup request to OpenAI",{messageCount:a.length});let n=await _({model:A,messages:a});console.log("[AI Service] Followup response received",{hasChoices:!!n.choices?.length,choiceCount:n.choices?.length||0});let i=n.choices[0]?.message;if(!i)throw console.error("[AI Service] No response from OpenAI followup call",{followup:JSON.stringify(n).substring(0,500)}),Error("No response from OpenAI followup call");if(i.tool_calls&&i.tool_calls.length>0)return console.error("[AI Service] Followup response has tool_calls instead of content",{toolCalls:i.tool_calls}),{reply:"I've processed your request. If you need additional help, please let me know.",toolCalls:s.tool_calls.map(e=>e.function.name),toolCallsData:s.tool_calls};let l=i.content??"";if(!l||0===l.trim().length){console.error("[AI Service] Empty reply from OpenAI followup call",{finalMsg:JSON.stringify(i).substring(0,500),hasContent:"content"in i,contentValue:i.content});let e=s.tool_calls.map(e=>e.function.name),t="I've processed your request. ";return e.includes("create_ticket")?t+="Your support ticket has been created. You should receive a confirmation shortly.":e.includes("search_knowledge_base")?t+="I searched the knowledge base for you. If you need more help, please let me know.":t+="If you need additional assistance, please let me know or create a support ticket.",{reply:t,toolCalls:e,toolCallsData:s.tool_calls}}return{reply:l,toolCalls:s.tool_calls.map(e=>e.function.name),toolCallsData:s.tool_calls}}var k=e.i(32932),N=e.i(50050),O=e.i(66991);let T=O.z.object({messages:O.z.array(O.z.object({role:O.z.enum(["user","assistant","system","tool"]),content:O.z.string().nullable(),name:O.z.string().optional(),tool_call_id:O.z.string().optional()})).optional(),conversationId:O.z.string().uuid().optional(),tenantId:O.z.string().uuid().optional()});async function S(e){let t=Math.random().toString(36).substring(7);console.log(`[Chat API] [${t}] POST request received`);try{let o,s,r=await (0,k.getAuthContext)(e);console.log(`[Chat API] [${t}] Auth context retrieved`,{hasUser:!!r?.user?.id,userId:r?.user?.id});let a=await e.json();console.log(`[Chat API] [${t}] Request body parsed`,{hasMessages:!!a.messages,messageCount:a.messages?.length||0,hasConversationId:!!a.conversationId,hasTenantId:!!a.tenantId});let n=T.parse(a);console.log(`[Chat API] [${t}] Request validated successfully`);let i=n.conversationId;!i&&r?.user?.id&&(i=(await (0,N.getOrCreateConversation)(r.user.id)).id);let l=[];if(n.messages&&n.messages.length>0&&(l=n.messages.map(e=>({role:e.role,content:e.content,name:e.name,tool_call_id:e.tool_call_id}))),0===l.length)return I.NextResponse.json({success:!1,error:{code:"VALIDATION_ERROR",message:"No messages provided"}},{status:400});r?.user?.id&&(o=r.user.organizationId||r.organizationId,s=r.user.roles),console.log(`[Chat API] [${t}] Calling chatWithTools`,{messageCount:l.length,hasRequesterId:!!r?.user?.id,hasTenantId:!!n.tenantId});let c=await b({messages:l,requesterId:r?.user?.id,tenantId:n.tenantId,organizationId:o,userRoles:s});if(console.log(`[Chat API] [${t}] chatWithTools completed`,{hasReply:!!c.reply,replyLength:c.reply?.length||0,replyPreview:c.reply?.substring(0,100),toolCallsCount:c.toolCalls?.length||0}),!c.reply||0===c.reply.trim().length)return console.error(`[Chat API] [${t}] Empty reply from chatWithTools`,{result:c}),I.NextResponse.json({success:!1,error:{code:"AI_ERROR",message:"Received empty response from AI service. Please try again."}},{status:500});if(i&&r?.user?.id){let e=l.filter(e=>"user"===e.role);if(e.length>0){let t=e[e.length-1];await (0,N.saveMessage)(i,"user",t.content||null)}let t=c.toolCallsData||null;await (0,N.saveMessage)(i,"assistant",c.reply,t,void 0)}return I.NextResponse.json({success:!0,data:{reply:c.reply,toolCalls:c.toolCalls,conversationId:i}},{status:200})}catch(e){if(e instanceof O.z.ZodError)return I.NextResponse.json({success:!1,error:{code:"VALIDATION_ERROR",message:"Invalid input data",details:e.errors}},{status:400});if(e instanceof Error)return console.error("AI Chat Error:",e.message,e.stack),I.NextResponse.json({success:!1,error:{code:"AI_ERROR",message:e.message}},{status:500});return I.NextResponse.json({success:!1,error:{code:"INTERNAL_ERROR",message:"An unexpected error occurred"}},{status:500})}}e.s(["POST",()=>S],72682);var P=e.i(72682);let x=new t.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/v1/ai/chat/route",pathname:"/api/v1/ai/chat",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/v1/ai/chat/route.ts",nextConfigOutput:"",userland:P}),{workAsyncStorage:q,workUnitAsyncStorage:j,serverHooks:D}=x;function M(){return(0,s.patchFetch)({workAsyncStorage:q,workUnitAsyncStorage:j})}async function H(e,t,s){x.isDev&&(0,r.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let I="/api/v1/ai/chat/route";I=I.replace(/\/index$/,"")||"/";let R=await x.prepare(e,t,{srcPage:I,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==s.waitUntil||s.waitUntil.call(s,Promise.resolve()),null;let{buildId:w,params:A,nextConfig:C,parsedUrl:_,isDraftMode:E,prerenderManifest:b,routerServerContext:k,isOnDemandRevalidate:N,revalidateOnlyGenerated:O,resolvedPathname:T,clientReferenceManifest:S,serverActionsManifest:P}=R,q=(0,l.normalizeAppPath)(I),j=!!(b.dynamicRoutes[q]||b.routes[T]),D=async()=>((null==k?void 0:k.render404)?await k.render404(e,t,_,!1):t.end("This page could not be found"),null);if(j&&!E){let e=!!b.routes[T],t=b.dynamicRoutes[q];if(t&&!1===t.fallback&&!e){if(C.experimental.adapterPath)return await D();throw new y.NoFallbackError}}let M=null;!j||x.isDev||E||(M="/index"===(M=T)?"/":M);let H=!0===x.isDev||!j,U=j&&!H;P&&S&&(0,n.setReferenceManifestsSingleton)({page:I,clientReferenceManifest:S,serverActionsManifest:P,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:P})});let $=e.method||"GET",L=(0,a.getTracer)(),z=L.getActiveScopeSpan(),F={params:A,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!C.experimental.authInterrupts},cacheComponents:!!C.cacheComponents,supportsDynamicResponse:H,incrementalCache:(0,r.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:C.cacheLife,waitUntil:s.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,o,s)=>x.onRequestError(e,t,s,k)},sharedContext:{buildId:w}},K=new c.NodeNextRequest(e),W=new c.NodeNextResponse(t),B=u.NextRequestAdapter.fromNodeNextRequest(K,(0,u.signalFromNodeResponse)(t));try{let n=async e=>x.handle(B,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let o=L.getRootSpanAttributes();if(!o)return;if(o.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${o.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=o.get("next.route");if(s){let t=`${$} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${I}`)}),i=!!(0,r.getRequestMeta)(e,"minimalMode"),l=async r=>{var a,l;let c=async({previousCacheEntry:o})=>{try{if(!i&&N&&O&&!o)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await n(r);e.fetchMetrics=F.renderOpts.fetchMetrics;let l=F.renderOpts.pendingWaitUntil;l&&s.waitUntil&&(s.waitUntil(l),l=void 0);let c=F.renderOpts.collectedTags;if(!j)return await (0,h.sendResponse)(K,W,a,F.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(a.headers);c&&(t[f.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let o=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,s=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:o,expire:s}}}}catch(t){throw(null==o?void 0:o.isStale)&&await x.onRequestError(e,t,{routerKind:"App Router",routePath:I,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:N})},k),t}},u=await x.handleResponse({req:e,nextConfig:C,cacheKey:M,routeKind:o.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:O,responseGenerator:c,waitUntil:s.waitUntil,isMinimalMode:i});if(!j)return null;if((null==u||null==(a=u.value)?void 0:a.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",N?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),E&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,g.fromNodeOutgoingHttpHeaders)(u.value.headers);return i&&j||d.delete(f.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,m.getCacheControlHeader)(u.cacheControl)),await (0,h.sendResponse)(K,W,new Response(u.value.body,{headers:d,status:u.value.status||200})),null};z?await l(z):await L.withPropagatedContext(e.headers,()=>L.trace(d.BaseServerSpan.handleRequest,{spanName:`${$} ${I}`,kind:a.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},l))}catch(t){if(t instanceof y.NoFallbackError||await x.onRequestError(e,t,{routerKind:"App Router",routePath:q,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:N})}),j)throw t;return await (0,h.sendResponse)(K,W,new Response(null,{status:500})),null}}e.s(["handler",()=>H,"patchFetch",()=>M,"routeModule",()=>x,"serverHooks",()=>D,"workAsyncStorage",()=>q,"workUnitAsyncStorage",()=>j],48206)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_de771142.js.map