module.exports=[70406,(e,t,i)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},18622,(e,t,i)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,i)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,i)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,i)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},24361,(e,t,i)=>{t.exports=e.x("util",()=>require("util"))},93695,(e,t,i)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},29173,(e,t,i)=>{t.exports=e.x("@prisma/client",()=>require("@prisma/client"))},15270,e=>{"use strict";var t=e.i(29173);let i=globalThis.prisma??new t.PrismaClient({log:["error"]});e.s(["default",0,i])},32932,e=>{"use strict";var t=e.i(86687),i=e.i(68105);async function r(e){try{let r=e.headers.get("authorization");if(!r||!r.startsWith("Bearer "))return null;let s=r.substring(7),a=(0,t.verifyToken)(s),n=await (0,i.getUserById)(a.userId);if(!n||!n.isActive)return null;let d=n.roles.map(e=>e.role?.name||(e.customRole?`CUSTOM:${e.customRole.name}`:null)).filter(e=>null!==e),u=d.includes("GLOBAL_ADMIN");return{user:{id:n.id,email:n.email,roles:d,organizationId:n.organizationId||void 0,isGlobalAdmin:u},organizationId:n.organizationId||void 0}}catch(e){return null}}function s(e){if(!e)throw Error("Unauthorized")}function a(e,t){if(s(e),!e.user.roles.includes(t))throw Error("Forbidden: Insufficient permissions")}function n(e,t){if(s(e),!t.some(t=>e.user.roles.includes(t)))throw Error("Forbidden: Insufficient permissions")}e.s(["getAuthContext",()=>r,"requireAnyRole",()=>n,"requireAuth",()=>s,"requireRole",()=>a])},98220,e=>{"use strict";var t=e.i(15270);async function i(e){return e.organizationId&&!await n(e.organizationId,e.eventType)?null:t.default.auditLog.create({data:{organizationId:e.organizationId,eventType:e.eventType,entityType:e.entityType,entityId:e.entityId,userId:e.userId,userEmail:e.userEmail,description:e.description,metadata:e.metadata?e.metadata:null,ipAddress:e.ipAddress,userAgent:e.userAgent}})}async function r(e={}){let{organizationId:i,eventType:s,entityType:a,entityId:n,userId:d,startDate:u,endDate:o,page:l=1,limit:c=50}=e,m={};void 0!==i&&(m.organizationId=i),s&&(m.eventType=s),a&&(m.entityType=a),n&&(m.entityId=n),d&&(m.userId=d),(u||o)&&(m.createdAt={},u&&(m.createdAt.gte=u),o&&(m.createdAt.lte=o));let[g,I]=await Promise.all([t.default.auditLog.findMany({where:m,skip:(l-1)*c,take:c,orderBy:{createdAt:"desc"},include:{user:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},organization:{select:{id:!0,name:!0,slug:!0}}}}),t.default.auditLog.count({where:m})]);return{logs:g,pagination:{page:l,limit:c,total:I,totalPages:Math.ceil(I/c)}}}async function s(e){return t.default.auditConfig.findUnique({where:{organizationId:e}})}async function a(e,i){return t.default.auditConfig.upsert({where:{organizationId:e},update:{enabled:i.enabled,events:i.events,retentionDays:i.retentionDays},create:{organizationId:e,enabled:i.enabled??!0,events:i.events??[],retentionDays:i.retentionDays}})}async function n(e,i){let r=await t.default.auditConfig.findUnique({where:{organizationId:e}});return!!r&&!!r.enabled&&r.events.includes(i)}e.s(["getAuditConfig",()=>s,"getAuditLogs",()=>r,"logEvent",()=>i,"updateAuditConfig",()=>a])},43934,e=>{"use strict";var t=e.i(98220);async function i(e,i,r,s,a,n,d,u){let o=u?.headers.get("x-forwarded-for")||u?.headers.get("x-real-ip")||"unknown",l=u?.headers.get("user-agent")||"unknown",c=d?.organizationId??null;try{await (0,t.logEvent)({organizationId:c,eventType:e,entityType:i,entityId:r,userId:s,userEmail:a,description:n,metadata:d,ipAddress:Array.isArray(o)?o[0]:o,userAgent:l})}catch(e){console.error("Failed to log audit event:",e)}}e.s(["auditLog",()=>i])},6461,(e,t,i)=>{t.exports=e.x("zlib",()=>require("zlib"))},27699,(e,t,i)=>{t.exports=e.x("events",()=>require("events"))},24836,(e,t,i)=>{t.exports=e.x("https",()=>require("https"))},21517,(e,t,i)=>{t.exports=e.x("http",()=>require("http"))},4446,(e,t,i)=>{t.exports=e.x("net",()=>require("net"))},55004,(e,t,i)=>{t.exports=e.x("tls",()=>require("tls"))},92509,(e,t,i)=>{t.exports=e.x("url",()=>require("url"))},86682,e=>{"use strict";var t=e.i(15270),i=e.i(29173),r=e.i(73421),s=e.i(89610);async function a(){let e=new Date().getFullYear(),t=Math.floor(9e3*Math.random())+1e3;return`TKT-${e}-${t.toString().padStart(4,"0")}`}async function n(n){let d=await a();if(!n.requesterId&&(!n.requesterEmail||!n.requesterName))throw Error("Either requesterId or requesterEmail/requesterName must be provided");let u=await t.default.ticket.create({data:{ticketNumber:d,subject:n.subject,description:n.description,requesterId:n.requesterId||null,requesterEmail:n.requesterEmail||null,requesterName:n.requesterName||null,publicTokenId:n.publicTokenId||null,assigneeId:n.assigneeId||null,tenantId:n.tenantId||null,organizationId:n.organizationId||null,category:n.category||null,customFields:n.customFields?n.customFields:null,priority:n.priority??i.TicketPriority.MEDIUM,status:i.TicketStatus.NEW},include:{requester:!!n.requesterId&&{select:{id:!0,email:!0,firstName:!0,lastName:!0}},assignee:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},tenant:{select:{id:!0,name:!0,slug:!0}}}});r.wsServer.broadcastToAll("ticket:created",{ticket:{id:u.id,ticketNumber:u.ticketNumber,subject:u.subject,status:u.status,priority:u.priority,requester:u.requester||{email:u.requesterEmail||"",name:u.requesterName||""},assignee:u.assignee,createdAt:u.createdAt}});let o=u;if(!u.assigneeId&&n.tenantId&&n.category){let{routeTicketByCategory:i,assignTicketToAgent:r}=await e.A(28642),s=await i({ticketId:u.id,tenantId:n.tenantId,category:n.category});if(s){await r(u.id,s);let e=await t.default.ticket.findUnique({where:{id:u.id},include:{requester:!!n.requesterId&&{select:{id:!0,email:!0,firstName:!0,lastName:!0}},assignee:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},tenant:{select:{id:!0,name:!0,slug:!0}}}});e&&(o=e)}}return o.assigneeId&&await (0,s.notifyTicketCreated)(o.id,o.ticketNumber,o.assigneeId),o}async function d(i){let r=i?.page||1,s=i?.limit||50,a=i?.sortBy||"createdAt",n=i?.sortOrder||"desc",d={};if(i?.status&&(d.status=i.status),i?.excludeStatuses&&i.excludeStatuses.length>0&&(d.status={notIn:i.excludeStatuses}),i?.assigneeId&&(d.assigneeId=i.assigneeId),i?.onlyAssignedToMe&&i?.userId&&(d.assigneeId=i.userId),i?.excludeAssignedToOthers&&i?.userId&&(d.OR=[{assigneeId:i.userId},{assigneeId:null}]),i?.priority&&(d.priority=i.priority),i?.requesterId&&(d.requesterId=i.requesterId),i?.publicTokenId&&(d.publicTokenId=i.publicTokenId),i?.tenantId&&(d.tenantId=i.tenantId),i?.category&&(d.category=i.category),i?.search){let e=i.search.trim();d.OR=[{subject:{contains:e,mode:"insensitive"}},{description:{contains:e,mode:"insensitive"}},{requesterEmail:{contains:e,mode:"insensitive"}},{requesterName:{contains:e,mode:"insensitive"}},{requester:{OR:[{email:{contains:e,mode:"insensitive"}},{firstName:{contains:e,mode:"insensitive"}},{lastName:{contains:e,mode:"insensitive"}}]}}]}if(i?.userId&&i?.userRoles&&!i.userRoles.includes("GLOBAL_ADMIN")){let e=await t.default.user.findUnique({where:{id:i.userId},select:{organizationId:!0}});if(!e?.organizationId)return{tickets:[],pagination:{page:r,limit:s,total:0,totalPages:0}};d.organizationId=e.organizationId}if(i?.organizationId&&(d.organizationId=i.organizationId),i?.userId&&i?.userRoles&&i.userRoles.some(e=>["AGENT","IT_MANAGER"].includes(e))&&!i.userRoles.includes("GLOBAL_ADMIN")&&!i.userRoles.includes("ADMIN")){let{getUserAssignedCategories:t}=await e.A(7412),a=await t(i.userId);if(!(a.size>0))return{tickets:[],pagination:{page:r,limit:s,total:0,totalPages:0}};{let e=[];if(a.forEach((t,i)=>{t.size>0&&e.push({tenantId:i,category:{in:Array.from(t)}})}),!(e.length>0))return{tickets:[],pagination:{page:r,limit:s,total:0,totalPages:0}};if(d.OR&&Array.isArray(d.OR)){let t=d.OR;delete d.OR,d.AND=[{OR:t},{OR:e}]}else d.OR||(d.OR=e)}}if(i?.excludeAssignedToOthers&&i?.userId){let e={OR:[{assigneeId:i.userId},{assigneeId:null}]};if(d.AND)d.AND.push(e);else if(d.OR&&Array.isArray(d.OR)){let t=d.OR;delete d.OR,d.AND=[{OR:t},e]}else d.AND=[e]}Object.keys(d).forEach(e=>{void 0===d[e]&&delete d[e]});let u={};u[["createdAt","updatedAt","ticketNumber","subject","status","priority"].includes(a)?a:"createdAt"]=n;let[o,l]=await Promise.all([t.default.ticket.findMany({where:d,orderBy:u,skip:(r-1)*s,take:s,include:{requester:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},assignee:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},tenant:{select:{id:!0,name:!0,slug:!0}}}}),t.default.ticket.count({where:d})]);return{tickets:o,pagination:{page:r,limit:s,total:l,totalPages:Math.ceil(l/s)}}}async function u(e){return t.default.ticket.findUnique({where:{id:e},include:{requester:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},assignee:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},tenant:{select:{id:!0,name:!0,slug:!0}},escalatedByUser:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},escalatedToCustomRole:{select:{id:!0,name:!0,displayName:!0}},comments:{orderBy:{createdAt:"asc"},include:{author:{select:{id:!0,email:!0,firstName:!0,lastName:!0}}}}}})}async function o(e,a){let n=await t.default.ticket.findUnique({where:{id:e},include:{requester:{select:{id:!0}},assignee:{select:{id:!0}}}});if(!n)throw Error("Ticket not found");let d=await t.default.ticket.update({where:{id:e},data:{subject:a.subject,description:a.description,status:a.status,priority:a.priority,assigneeId:a.assigneeId,closedAt:a.status===i.TicketStatus.CLOSED?new Date:void 0},include:{requester:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},assignee:{select:{id:!0,email:!0,firstName:!0,lastName:!0}}}}),u={};a.status&&a.status!==n.status&&(u.status={from:n.status,to:a.status}),a.priority&&a.priority!==n.priority&&(u.priority={from:n.priority,to:a.priority}),void 0!==a.assigneeId&&a.assigneeId!==n.assigneeId&&(u.assigneeId={from:n.assigneeId,to:a.assigneeId}),r.wsServer.broadcastToTicketSubscribers(e,"ticket:updated",{ticket:{id:d.id,ticketNumber:d.ticketNumber,subject:d.subject,status:d.status,priority:d.priority,requester:d.requester,assignee:d.assignee,updatedAt:d.updatedAt},changes:u});let o=[];return d.requesterId&&o.push(d.requesterId),d.assigneeId&&o.push(d.assigneeId),n.requesterId&&!o.includes(n.requesterId)&&o.push(n.requesterId),n.assigneeId&&!o.includes(n.assigneeId)&&o.push(n.assigneeId),Object.keys(u).length>0&&o.length>0&&await (0,s.notifyTicketUpdated)(d.id,d.ticketNumber,u,o),void 0!==a.assigneeId&&a.assigneeId!==n.assigneeId&&a.assigneeId&&(await (0,s.notifyTicketAssigned)(d.id,d.ticketNumber,a.assigneeId),r.wsServer.broadcastToUser(a.assigneeId,"ticket:assigned",{ticket:{id:d.id,ticketNumber:d.ticketNumber,subject:d.subject}})),d}async function l(e){let i=await t.default.ticket.findUnique({where:{id:e.ticketId},include:{requester:{select:{id:!0}},assignee:{select:{id:!0}},comments:{select:{authorId:!0},distinct:["authorId"]}}});if(!i)throw Error("Ticket not found");let a=await t.default.ticketComment.create({data:{ticketId:e.ticketId,authorId:e.authorId,body:e.body},include:{author:{select:{id:!0,email:!0,firstName:!0,lastName:!0}}}});r.wsServer.broadcastToTicketSubscribers(e.ticketId,"ticket:comment",{ticketId:e.ticketId,comment:{id:a.id,body:a.body,author:a.author,createdAt:a.createdAt}});let n=[];return i.requesterId&&n.push(i.requesterId),i.assigneeId&&n.push(i.assigneeId),i.comments.forEach(e=>{e.authorId&&!n.includes(e.authorId)&&n.push(e.authorId)}),n.length>0&&await (0,s.notifyTicketComment)(e.ticketId,i.ticketNumber,e.authorId,n),a}async function c(e,i){return(await t.default.ticket.updateMany({where:{publicTokenId:e,requesterId:null},data:{requesterId:i,publicTokenId:null}})).count}e.s(["addTicketComment",()=>l,"createTicket",()=>n,"generateTicketNumber",()=>a,"getTicketById",()=>u,"listTickets",()=>d,"mergePublicTokenTicketsToUser",()=>c,"updateTicket",()=>o])},35683,e=>{"use strict";var t=e.i(15270);async function i(e){return t.default.ticketHistory.create({data:{ticketId:e.ticketId,type:e.type,userId:e.userId,oldValue:e.oldValue||null,newValue:e.newValue||null,note:e.note||null,metadata:e.metadata?e.metadata:null},include:{user:{select:{id:!0,email:!0,firstName:!0,lastName:!0}}}})}e.s(["createTicketHistory",()=>i])},28642,e=>{e.v(t=>Promise.all(["server/chunks/lib_services_ticket-routing-service_ts_1e1adca9._.js"].map(t=>e.l(t))).then(()=>t(43887)))},7412,e=>{e.v(t=>Promise.all(["server/chunks/lib_services_tenant-service_ts_e0fbdcc5._.js"].map(t=>e.l(t))).then(()=>t(16766)))},58338,e=>{e.v(e=>Promise.resolve().then(()=>e(86687)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__2120796d._.js.map