// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum RoleName {
  ADMIN
  IT_MANAGER
  AGENT
  END_USER
  REQUESTER
}

enum TicketStatus {
  NEW
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum EmailProtocol {
  IMAP
  POP3
  SMTP
}

enum EmailEncryption {
  NONE
  SSL
  TLS
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  firstName     String?
  lastName      String?
  avatar        String?
  isActive      Boolean   @default(true)
  emailVerified Boolean   @default(false)
  passwordResetToken String? @unique
  passwordResetExpires DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?

  roles         UserRole[]
  ticketsRequested Ticket[] @relation("TicketRequester")
  ticketsAssigned  Ticket[] @relation("TicketAssignee")
  ticketComments   TicketComment[]

  @@index([email])
  @@index([isActive])
}

model Role {
  id        String    @id @default(uuid())
  name      RoleName  @unique
  description String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  users     UserRole[]

  @@index([name])
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String
  roleId    String
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
}

model Ticket {
  id           String         @id @default(uuid())
  ticketNumber String         @unique
  subject      String
  description  String
  status       TicketStatus   @default(NEW)
  priority     TicketPriority @default(MEDIUM)
  requesterId  String
  assigneeId   String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  closedAt     DateTime?

  requester    User           @relation("TicketRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  assignee     User?          @relation("TicketAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  comments     TicketComment[]

  @@index([ticketNumber])
  @@index([status])
  @@index([priority])
  @@index([requesterId])
  @@index([assigneeId])
}

model TicketComment {
  id        String   @id @default(uuid())
  ticketId  String
  authorId  String
  body      String
  createdAt DateTime @default(now())

  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([authorId])
}

model EmailConfiguration {
  id            String          @id @default(uuid())
  providerName  String?
  protocol      EmailProtocol
  host          String
  port          Int
  username      String
  password      String
  encryption    EmailEncryption @default(SSL)
  pollingIntervalMinutes Int    @default(5)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([protocol])
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
}

model KnowledgeBaseArticle {
  id          String        @id @default(uuid())
  slug        String        @unique
  title       String
  content     String
  status      ArticleStatus @default(PUBLISHED)
  tags        String[]
  helpfulCount    Int       @default(0)
  notHelpfulCount Int       @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  embedding   Unsupported("vector")?

  @@index([status])
  @@index([tags])
  @@index([title])
}

