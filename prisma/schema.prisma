// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum RoleName {
  ADMIN
  IT_MANAGER
  AGENT
  END_USER
  REQUESTER
}

enum TicketStatus {
  NEW
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum EmailProtocol {
  IMAP
  POP3
  SMTP
}

enum EmailEncryption {
  NONE
  SSL
  TLS
}

model User {
  id                   String    @id @default(uuid())
  email                String    @unique
  passwordHash         String
  firstName            String?
  lastName             String?
  avatar               String?
  isActive             Boolean   @default(true)
  emailVerified        Boolean   @default(false)
  passwordResetToken   String?   @unique
  passwordResetExpires DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  deletedAt            DateTime?

  roles                  UserRole[]
  ticketsRequested       Ticket[]              @relation("TicketRequester")
  ticketsAssigned        Ticket[]              @relation("TicketAssignee")
  ticketComments         TicketComment[]
  assignedAssets         Asset[]               @relation("AssetAssignee")
  changeRequests         ChangeRequest[]       @relation("ChangeCreator")
  changeApprovals        ChangeApproval[]
  notifications          Notification[]
  notificationPreference NotificationPreference?

  @@index([email])
  @@index([isActive])
}

model Role {
  id          String   @id @default(uuid())
  name        RoleName @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users UserRole[]

  @@index([name])
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String
  roleId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
}

model Ticket {
  id           String         @id @default(uuid())
  ticketNumber String         @unique
  subject      String
  description  String
  status       TicketStatus   @default(NEW)
  priority     TicketPriority @default(MEDIUM)
  requesterId  String
  assigneeId   String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  closedAt     DateTime?

  requester      User                  @relation("TicketRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  assignee       User?                 @relation("TicketAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  comments       TicketComment[]
  assetRelations TicketAssetRelation[]
  relatedChanges ChangeRequest[]
  slaPolicy      SLAPolicy?            @relation(fields: [slaPolicyId], references: [id], onDelete: SetNull)
  slaPolicyId    String?
  slaTracking    SLATracking?

  @@index([ticketNumber])
  @@index([status])
  @@index([priority])
  @@index([requesterId])
  @@index([assigneeId])
  @@index([slaPolicyId])
}

model TicketComment {
  id        String   @id @default(uuid())
  ticketId  String
  authorId  String
  body      String
  createdAt DateTime @default(now())

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  author User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([authorId])
}

model EmailConfiguration {
  id                     String          @id @default(uuid())
  providerName           String?
  protocol               EmailProtocol
  host                   String
  port                   Int
  username               String
  password               String
  encryption             EmailEncryption @default(SSL)
  pollingIntervalMinutes Int             @default(5)
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt

  @@index([protocol])
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
}

model KnowledgeBaseArticle {
  id              String                 @id @default(uuid())
  slug            String                 @unique
  title           String
  content         String
  status          ArticleStatus          @default(PUBLISHED)
  tags            String[]
  helpfulCount    Int                    @default(0)
  notHelpfulCount Int                    @default(0)
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  embedding       Unsupported("vector")?

  @@index([status])
  @@index([tags])
  @@index([title])
}

enum AssetType {
  HARDWARE
  SOFTWARE
  NETWORK_DEVICE
  CLOUD_RESOURCE
}

enum AssetStatus {
  ACTIVE
  INACTIVE
  RETIRED
  MAINTENANCE
}

enum RelationshipType {
  CONTAINS
  DEPENDS_ON
  CONNECTED_TO
  LICENSED_FOR
}

enum TicketAssetRelationType {
  AFFECTED_BY
  CAUSED_BY
  RELATED_TO
}

enum ChangeType {
  STANDARD
  NORMAL
  EMERGENCY
}

enum ChangeStatus {
  DRAFT
  SUBMITTED
  IN_REVIEW
  APPROVED
  REJECTED
  IMPLEMENTED
  CLOSED
}

enum ChangePriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

model Asset {
  id           String      @id @default(uuid())
  assetNumber  String      @unique
  name         String
  type         AssetType
  category     String?
  manufacturer String?
  model        String?
  serialNumber String?
  status       AssetStatus @default(ACTIVE)

  // Assignment
  assignedToId String?
  assignedAt   DateTime?

  // Location
  location String?
  building String?
  floor    String?
  room     String?

  // Purchase Info
  purchaseDate   DateTime?
  purchasePrice  Decimal?  @db.Decimal(10, 2)
  warrantyExpiry DateTime?

  // Custom Fields (JSON)
  customFields Json?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?

  // Relations
  assignedTo      User?                 @relation("AssetAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)
  relationships   AssetRelationship[]   @relation("SourceAsset")
  relatedAssets   AssetRelationship[]   @relation("TargetAsset")
  ticketRelations TicketAssetRelation[]

  @@index([assetNumber])
  @@index([type])
  @@index([status])
  @@index([assignedToId])
  @@index([createdAt])
  @@index([deletedAt])
}

model AssetRelationship {
  id               String           @id @default(uuid())
  sourceAssetId    String
  targetAssetId    String
  relationshipType RelationshipType
  description      String?          @db.Text

  createdAt   DateTime @default(now())
  createdById String?

  // Relations
  sourceAsset Asset @relation("SourceAsset", fields: [sourceAssetId], references: [id], onDelete: Cascade)
  targetAsset Asset @relation("TargetAsset", fields: [targetAssetId], references: [id], onDelete: Cascade)

  @@unique([sourceAssetId, targetAssetId, relationshipType])
  @@index([sourceAssetId])
  @@index([targetAssetId])
}

model TicketAssetRelation {
  id           String                  @id @default(uuid())
  ticketId     String
  assetId      String
  relationType TicketAssetRelationType @default(AFFECTED_BY)

  createdAt   DateTime @default(now())
  createdById String?

  // Relations
  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  asset  Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([ticketId, assetId, relationType])
  @@index([ticketId])
  @@index([assetId])
}

model ChangeRequest {
  id           String         @id @default(uuid())
  changeNumber String         @unique
  title        String
  description  String         @db.Text
  type         ChangeType
  status       ChangeStatus   @default(DRAFT)
  priority     ChangePriority @default(MEDIUM)
  riskLevel    RiskLevel?

  // Request Info
  requestedById String
  requestedAt   DateTime @default(now())

  // Implementation
  plannedStartDate    DateTime?
  plannedEndDate      DateTime?
  actualStartDate     DateTime?
  actualEndDate       DateTime?
  implementationNotes String?   @db.Text

  // Related Ticket
  relatedTicketId String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  requester     User             @relation("ChangeCreator", fields: [requestedById], references: [id], onDelete: Cascade)
  relatedTicket Ticket?          @relation(fields: [relatedTicketId], references: [id], onDelete: SetNull)
  approvals     ChangeApproval[]

  @@index([changeNumber])
  @@index([status])
  @@index([type])
  @@index([requestedById])
  @@index([createdAt])
  @@index([deletedAt])
}

model ChangeApproval {
  id              String         @id @default(uuid())
  changeRequestId String
  approverId      String
  stage           Int
  status          ApprovalStatus @default(PENDING)
  comments        String?        @db.Text
  approvedAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  changeRequest ChangeRequest @relation(fields: [changeRequestId], references: [id], onDelete: Cascade)
  approver      User          @relation(fields: [approverId], references: [id], onDelete: Cascade)

  @@unique([changeRequestId, approverId, stage])
  @@index([changeRequestId])
  @@index([approverId])
  @@index([status])
}

model SLAPolicy {
  id                String         @id @default(uuid())
  name              String
  description       String?        @db.Text
  priority          TicketPriority
  firstResponseTime Int // Minutes
  resolutionTime    Int // Minutes
  businessHours     Json? // Business hours definition
  active            Boolean        @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tickets         Ticket[]
  tracking        SLATracking[]
  escalationRules EscalationRule[]

  @@index([priority])
  @@index([active])
}

model SLATracking {
  id                    String    @id @default(uuid())
  ticketId              String    @unique
  slaPolicyId           String
  firstResponseTarget   DateTime?
  firstResponseActual   DateTime?
  firstResponseBreached Boolean   @default(false)
  resolutionTarget      DateTime?
  resolutionActual      DateTime?
  resolutionBreached    Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ticket    Ticket    @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  slaPolicy SLAPolicy @relation(fields: [slaPolicyId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([slaPolicyId])
  @@index([firstResponseBreached])
  @@index([resolutionBreached])
}

model EscalationRule {
  id               String          @id @default(uuid())
  slaPolicyId      String
  name             String
  description      String?         @db.Text
  triggerCondition String // "FIRST_RESPONSE_BREACHED", "RESOLUTION_BREACHED", "NO_RESPONSE", "NO_ASSIGNEE"
  triggerTime      Int? // Minutes (for time-based triggers)
  action           String // "ASSIGN_TO_MANAGER", "INCREASE_PRIORITY", "NOTIFY_STAKEHOLDERS", "CREATE_CHANGE"
  targetUserId     String? // For assign actions
  newPriority      TicketPriority? // For priority increase
  active           Boolean         @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  slaPolicy SLAPolicy @relation(fields: [slaPolicyId], references: [id], onDelete: Cascade)

  @@index([slaPolicyId])
  @@index([active])
}

enum NotificationType {
  TICKET_CREATED
  TICKET_UPDATED
  TICKET_ASSIGNED
  TICKET_COMMENT
  CHANGE_REQUEST_CREATED
  CHANGE_REQUEST_APPROVED
  CHANGE_REQUEST_REJECTED
  SLA_BREACHED
  ESCALATION
}

enum NotificationStatus {
  UNREAD
  READ
  ARCHIVED
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String           @db.Text
  status    NotificationStatus @default(UNREAD)
  link      String? // URL to related resource
  metadata  Json? // Additional data (e.g., ticketId, changeRequestId)
  readAt    DateTime?
  createdAt DateTime         @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
}

model NotificationPreference {
  id                    String   @id @default(uuid())
  userId                 String   @unique
  emailEnabled           Boolean  @default(true)
  pushEnabled            Boolean  @default(true)
  ticketCreated          Boolean  @default(true)
  ticketUpdated          Boolean  @default(true)
  ticketAssigned         Boolean  @default(true)
  ticketComment          Boolean  @default(true)
  changeRequestCreated   Boolean  @default(true)
  changeRequestApproved  Boolean  @default(true)
  changeRequestRejected  Boolean  @default(true)
  slaBreached            Boolean  @default(true)
  escalation             Boolean  @default(true)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
