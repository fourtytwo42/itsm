// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RoleName {
  GLOBAL_ADMIN
  ADMIN
  IT_MANAGER
  AGENT
  END_USER
  REQUESTER
}

enum TicketStatus {
  NEW
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum EmailProtocol {
  IMAP
  POP3
  SMTP
}

enum EmailEncryption {
  NONE
  SSL
  TLS
}

model User {
  id                   String    @id @default(uuid())
  email                String    @unique
  passwordHash         String
  firstName            String?
  lastName             String?
  avatar               String?
  isActive             Boolean   @default(true)
  emailVerified        Boolean   @default(false)
  passwordResetToken   String?   @unique
  passwordResetExpires DateTime?
  mustChangePassword   Boolean  @default(false) // Force password change on first login
  tenantId             String?   // Multi-tenant support (backward compatibility)
  organizationId       String?  // User belongs to an organization
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  deletedAt            DateTime?

  tenant               Tenant?   @relation("UserTenant", fields: [tenantId], references: [id], onDelete: SetNull)
  organization         Organization? @relation("UserOrganization", fields: [organizationId], references: [id], onDelete: SetNull)
  roles                  UserRole[]
  ticketsRequested       Ticket[]                @relation("TicketRequester")
  ticketsAssigned        Ticket[]                @relation("TicketAssignee")
  ticketComments         TicketComment[]
  assignedAssets         Asset[]                 @relation("AssetAssignee")
  changeRequests         ChangeRequest[]         @relation("ChangeCreator")
  changeApprovals        ChangeApproval[]
  notifications          Notification[]
  notificationPreference NotificationPreference?
  updatedSettings        SystemSetting[]
  tenantAssignments      TenantAssignment[]
  auditLogs             AuditLog[]

  @@index([email])
  @@index([isActive])
  @@index([tenantId])
  @@index([organizationId])
}

model Role {
  id          String   @id @default(uuid())
  name        RoleName @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users UserRole[]

  @@index([name])
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String
  roleId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
}

model Ticket {
  id           String         @id @default(uuid())
  ticketNumber String         @unique
  subject      String
  description  String
  status       TicketStatus   @default(NEW)
  priority     TicketPriority @default(MEDIUM)
  requesterId  String?
  requesterEmail String?      // For unauthenticated users
  requesterName  String?      // For unauthenticated users
  publicTokenId String?       // For tickets created by anonymous users with public JWT
  assigneeId   String?
  tenantId     String?
  organizationId String?      // Ticket belongs to an organization
  category     String?
  customFields Json?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  closedAt     DateTime?

  requester      User?                 @relation("TicketRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  assignee       User?                 @relation("TicketAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  tenant         Tenant?               @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  organization   Organization?         @relation("TicketOrganization", fields: [organizationId], references: [id], onDelete: SetNull)
  comments       TicketComment[]
  assetRelations TicketAssetRelation[]
  relatedChanges ChangeRequest[]
  slaPolicy      SLAPolicy?            @relation(fields: [slaPolicyId], references: [id], onDelete: SetNull)
  slaPolicyId    String?
  slaTracking    SLATracking?

  @@index([ticketNumber])
  @@index([status])
  @@index([priority])
  @@index([requesterId])
  @@index([assigneeId])
  @@index([slaPolicyId])
  @@index([tenantId])
  @@index([category])
  @@index([organizationId])
  @@index([publicTokenId])
}

model TicketComment {
  id        String   @id @default(uuid())
  ticketId  String
  authorId  String
  body      String
  createdAt DateTime @default(now())

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  author User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([authorId])
}

model EmailConfiguration {
  id                     String          @id @default(uuid())
  providerName           String?
  protocol               EmailProtocol
  host                   String
  port                   Int
  username               String
  password               String
  encryption             EmailEncryption @default(SSL)
  pollingIntervalMinutes Int             @default(5)
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt

  @@index([protocol])
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
}

model KnowledgeBaseArticle {
  id              String                 @id @default(uuid())
  slug            String                 @unique
  title           String
  content         String
  status          ArticleStatus          @default(PUBLISHED)
  tags            String[]
  helpfulCount    Int                    @default(0)
  notHelpfulCount Int                    @default(0)
  tenantId        String?                // Multi-tenant support
  organizationId String?                // Article belongs to an organization
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  embedding       Unsupported("vector")?
  tenant          Tenant?                @relation("KBArticleTenant", fields: [tenantId], references: [id], onDelete: SetNull)
  organization    Organization?          @relation("KBArticleOrganization", fields: [organizationId], references: [id], onDelete: SetNull)
  tenantArticles  TenantKBArticle[]

  @@index([status])
  @@index([tags])
  @@index([title])
  @@index([tenantId])
  @@index([organizationId])
}

enum AssetType {
  HARDWARE
  SOFTWARE
  NETWORK_DEVICE
  CLOUD_RESOURCE
}

enum AssetStatus {
  ACTIVE
  INACTIVE
  RETIRED
  MAINTENANCE
}

enum RelationshipType {
  CONTAINS
  DEPENDS_ON
  CONNECTED_TO
  LICENSED_FOR
}

enum TicketAssetRelationType {
  AFFECTED_BY
  CAUSED_BY
  RELATED_TO
}

enum ChangeType {
  STANDARD
  NORMAL
  EMERGENCY
}

enum ChangeStatus {
  DRAFT
  SUBMITTED
  IN_REVIEW
  APPROVED
  REJECTED
  IMPLEMENTED
  CLOSED
}

enum ChangePriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

// Custom Asset Types - Allows orgs to create custom asset types like "Laptops", "Desktops" under HARDWARE
model CustomAssetType {
  id           String   @id @default(uuid())
  name         String   // e.g., "Laptops", "Desktops", "Servers"
  baseType     AssetType // The base type this custom type belongs to (HARDWARE, SOFTWARE, etc.)
  organizationId String
  description  String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  organization Organization? @relation("CustomAssetTypeOrganization", fields: [organizationId], references: [id], onDelete: Cascade)
  customFields AssetTypeCustomField[] @relation("AssetTypeCustomFields")
  assets       Asset[] @relation("AssetCustomType")

  @@unique([organizationId, name, baseType]) // Unique per org, name, and base type
  @@index([organizationId])
  @@index([baseType])
  @@index([isActive])
}

// Custom Fields for Asset Types
model AssetTypeCustomField {
  id              String   @id @default(uuid())
  customAssetTypeId String
  fieldName       String   // Internal field name (e.g., "screenSize", "ram")
  label           String   // Display label (e.g., "Screen Size", "RAM")
  fieldType       String   // "text", "number", "date", "select", "textarea", "checkbox"
  required        Boolean  @default(false)
  defaultValue    String?
  options         Json?    // For select/checkbox types - array of options
  placeholder     String?
  order           Int      @default(0)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  customAssetType CustomAssetType @relation("AssetTypeCustomFields", fields: [customAssetTypeId], references: [id], onDelete: Cascade)

  @@index([customAssetTypeId])
  @@index([order])
  @@index([isActive])
}

model Asset {
  id           String      @id @default(uuid())
  assetNumber  String      @unique
  name         String
  type         AssetType
  customAssetTypeId String? // Link to custom asset type (e.g., "Laptops", "Desktops")
  category     String?
  manufacturer String?
  model        String?
  serialNumber String?
  status       AssetStatus @default(ACTIVE)
  tenantId     String?     // Multi-tenant support
  organizationId String?   // Asset belongs to an organization

  // Assignment
  assignedToId String?
  assignedAt   DateTime?

  // Location
  location String?
  building String?
  floor    String?
  room     String?

  // Purchase Info
  purchaseDate   DateTime?
  purchasePrice  Decimal?  @db.Decimal(10, 2)
  warrantyExpiry DateTime?

  // Custom Fields (JSON)
  customFields Json?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?

  // Relations
  tenant          Tenant?               @relation("AssetTenant", fields: [tenantId], references: [id], onDelete: SetNull)
  organization    Organization?         @relation("AssetOrganization", fields: [organizationId], references: [id], onDelete: SetNull)
  assignedTo      User?                 @relation("AssetAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)
  customAssetType CustomAssetType?      @relation("AssetCustomType", fields: [customAssetTypeId], references: [id], onDelete: SetNull)
  relationships   AssetRelationship[]   @relation("SourceAsset")
  relatedAssets   AssetRelationship[]   @relation("TargetAsset")
  ticketRelations TicketAssetRelation[]

  @@index([assetNumber])
  @@index([type])
  @@index([status])
  @@index([assignedToId])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([tenantId])
  @@index([organizationId])
  @@index([customAssetTypeId])
}

model AssetRelationship {
  id               String           @id @default(uuid())
  sourceAssetId    String
  targetAssetId    String
  relationshipType RelationshipType
  description      String?          @db.Text

  createdAt   DateTime @default(now())
  createdById String?

  // Relations
  sourceAsset Asset @relation("SourceAsset", fields: [sourceAssetId], references: [id], onDelete: Cascade)
  targetAsset Asset @relation("TargetAsset", fields: [targetAssetId], references: [id], onDelete: Cascade)

  @@unique([sourceAssetId, targetAssetId, relationshipType])
  @@index([sourceAssetId])
  @@index([targetAssetId])
}

model TicketAssetRelation {
  id           String                  @id @default(uuid())
  ticketId     String
  assetId      String
  relationType TicketAssetRelationType @default(AFFECTED_BY)

  createdAt   DateTime @default(now())
  createdById String?

  // Relations
  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  asset  Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([ticketId, assetId, relationType])
  @@index([ticketId])
  @@index([assetId])
}

model ChangeRequest {
  id           String         @id @default(uuid())
  changeNumber String         @unique
  title        String
  description  String         @db.Text
  type         ChangeType
  status       ChangeStatus   @default(DRAFT)
  priority     ChangePriority @default(MEDIUM)
  riskLevel    RiskLevel?
  tenantId     String?        // Multi-tenant support
  organizationId String?      // Change request belongs to an organization

  // Request Info
  requestedById String
  requestedAt   DateTime @default(now())

  // Implementation
  plannedStartDate    DateTime?
  plannedEndDate      DateTime?
  actualStartDate     DateTime?
  actualEndDate       DateTime?
  implementationNotes String?   @db.Text

  // Related Ticket
  relatedTicketId String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  tenant        Tenant?          @relation("ChangeTenant", fields: [tenantId], references: [id], onDelete: SetNull)
  organization  Organization?    @relation("ChangeOrganization", fields: [organizationId], references: [id], onDelete: SetNull)
  requester     User             @relation("ChangeCreator", fields: [requestedById], references: [id], onDelete: Cascade)
  relatedTicket Ticket?          @relation(fields: [relatedTicketId], references: [id], onDelete: SetNull)
  approvals     ChangeApproval[]

  @@index([changeNumber])
  @@index([status])
  @@index([type])
  @@index([requestedById])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([tenantId])
  @@index([organizationId])
}

model ChangeApproval {
  id              String         @id @default(uuid())
  changeRequestId String
  approverId      String
  stage           Int
  status          ApprovalStatus @default(PENDING)
  comments        String?        @db.Text
  approvedAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  changeRequest ChangeRequest @relation(fields: [changeRequestId], references: [id], onDelete: Cascade)
  approver      User          @relation(fields: [approverId], references: [id], onDelete: Cascade)

  @@unique([changeRequestId, approverId, stage])
  @@index([changeRequestId])
  @@index([approverId])
  @@index([status])
}

model SLAPolicy {
  id                String         @id @default(uuid())
  name              String
  description       String?        @db.Text
  priority          TicketPriority
  firstResponseTime Int // Minutes
  resolutionTime    Int // Minutes
  businessHours     Json? // Business hours definition
  active            Boolean        @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tickets         Ticket[]
  tracking        SLATracking[]
  escalationRules EscalationRule[]

  @@index([priority])
  @@index([active])
}

model SLATracking {
  id                    String    @id @default(uuid())
  ticketId              String    @unique
  slaPolicyId           String
  firstResponseTarget   DateTime?
  firstResponseActual   DateTime?
  firstResponseBreached Boolean   @default(false)
  resolutionTarget      DateTime?
  resolutionActual      DateTime?
  resolutionBreached    Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ticket    Ticket    @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  slaPolicy SLAPolicy @relation(fields: [slaPolicyId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([slaPolicyId])
  @@index([firstResponseBreached])
  @@index([resolutionBreached])
}

model EscalationRule {
  id               String          @id @default(uuid())
  slaPolicyId      String
  name             String
  description      String?         @db.Text
  triggerCondition String // "FIRST_RESPONSE_BREACHED", "RESOLUTION_BREACHED", "NO_RESPONSE", "NO_ASSIGNEE"
  triggerTime      Int? // Minutes (for time-based triggers)
  action           String // "ASSIGN_TO_MANAGER", "INCREASE_PRIORITY", "NOTIFY_STAKEHOLDERS", "CREATE_CHANGE"
  targetUserId     String? // For assign actions
  newPriority      TicketPriority? // For priority increase
  active           Boolean         @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  slaPolicy SLAPolicy @relation(fields: [slaPolicyId], references: [id], onDelete: Cascade)

  @@index([slaPolicyId])
  @@index([active])
}

enum NotificationType {
  TICKET_CREATED
  TICKET_UPDATED
  TICKET_ASSIGNED
  TICKET_COMMENT
  CHANGE_REQUEST_CREATED
  CHANGE_REQUEST_APPROVED
  CHANGE_REQUEST_REJECTED
  SLA_BREACHED
  ESCALATION
}

enum NotificationStatus {
  UNREAD
  READ
  ARCHIVED
}

model Notification {
  id        String             @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String             @db.Text
  status    NotificationStatus @default(UNREAD)
  link      String? // URL to related resource
  metadata  Json? // Additional data (e.g., ticketId, changeRequestId)
  readAt    DateTime?
  createdAt DateTime           @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
}

model NotificationPreference {
  id                    String   @id @default(uuid())
  userId                String   @unique
  emailEnabled          Boolean  @default(true)
  pushEnabled           Boolean  @default(true)
  ticketCreated         Boolean  @default(true)
  ticketUpdated         Boolean  @default(true)
  ticketAssigned        Boolean  @default(true)
  ticketComment         Boolean  @default(true)
  changeRequestCreated  Boolean  @default(true)
  changeRequestApproved Boolean  @default(true)
  changeRequestRejected Boolean  @default(true)
  slaBreached           Boolean  @default(true)
  escalation            Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum SettingCategory {
  AUTHENTICATION
  EMAIL
  FILE_UPLOAD
  BRANDING
  TICKET
  SYSTEM
}

model SystemSetting {
  id          String          @id @default(uuid())
  key         String          @unique
  category    SettingCategory
  value       Json // Flexible JSON value
  description String?         @db.Text
  updatedBy   String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  updatedByUser User? @relation(fields: [updatedBy], references: [id], onDelete: SetNull)

  @@index([category])
  @@index([key])
}

model CustomField {
  id           String   @id @default(uuid())
  name         String
  label        String
  type         String // "text", "number", "date", "select", "textarea", "checkbox"
  required     Boolean  @default(false)
  defaultValue String?
  options      Json? // For select/checkbox types
  entityType   String // "ticket", "asset", "change", "user"
  order        Int      @default(0)
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([entityType])
  @@index([active])
}

model TicketType {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?  @db.Text
  icon        String? // Icon identifier
  color       String? // Hex color
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([active])
}

// Tenant System Models - Add to end of schema.prisma

enum CustomFieldType {
  TEXT
  TEXTAREA
  NUMBER
  EMAIL
  PHONE
  DATE
  SELECT
  CHECKBOX
}

model Tenant {
  id            String   @id @default(uuid())
  name          String
  slug          String   @unique
  logo          String?
  description   String?
  requiresLogin Boolean  @default(false)
  isActive      Boolean  @default(true)
  organizationId String? // Tenant belongs to an organization (nullable for migration)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  categories   TenantCategory[]
  kbArticles   TenantKBArticle[]
  customFields TenantCustomField[]
  assignments  TenantAssignment[]
  tickets      Ticket[]
  users        User[]            @relation("UserTenant")
  assets       Asset[]           @relation("AssetTenant")
  changes      ChangeRequest[]   @relation("ChangeTenant")
  kbArticles2  KnowledgeBaseArticle[] @relation("KBArticleTenant")
  organization Organization?     @relation("TenantOrganization", fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([slug])
  @@index([isActive])
  @@index([organizationId])
}

model TenantCategory {
  id        String   @id @default(uuid())
  tenantId  String
  category  String
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, category])
  @@index([tenantId])
  @@index([category])
}

model TenantKBArticle {
  id        String   @id @default(uuid())
  tenantId  String
  articleId String
  createdAt DateTime @default(now())

  tenant  Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  article KnowledgeBaseArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([tenantId, articleId])
  @@index([tenantId])
  @@index([articleId])
}

model TenantCustomField {
  id          String          @id @default(uuid())
  tenantId    String
  label       String
  fieldType   CustomFieldType @default(TEXT)
  required    Boolean         @default(false)
  options     String[] // For SELECT type
  placeholder String?
  order       Int             @default(0)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([order])
}

model TenantAssignment {
  id        String   @id @default(uuid())
  tenantId  String
  userId    String
  category  String? // If null, assigned to all categories for this tenant
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId, category])
  @@index([tenantId])
  @@index([userId])
  @@index([category])
}

// Organization Model
model Organization {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  logo        String?
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users       User[]           @relation("UserOrganization")
  tenants     Tenant[]         @relation("TenantOrganization")
  kbArticles  KnowledgeBaseArticle[] @relation("KBArticleOrganization")
  changes     ChangeRequest[]  @relation("ChangeOrganization")
  assets      Asset[]          @relation("AssetOrganization")
  tickets     Ticket[]         @relation("TicketOrganization")
  auditLogs   AuditLog[]       @relation("AuditLogOrganization")
  auditConfig AuditConfig?     @relation("AuditConfigOrganization")
  customAssetTypes CustomAssetType[] @relation("CustomAssetTypeOrganization")

  @@index([slug])
  @@index([isActive])
}

// Audit Trail System
enum AuditEventType {
  // User Events
  USER_CREATED
  USER_UPDATED
  USER_DELETED
  USER_ACTIVATED
  USER_DEACTIVATED
  USER_PASSWORD_RESET
  USER_ROLE_CHANGED
  
  // Organization Events
  ORGANIZATION_CREATED
  ORGANIZATION_UPDATED
  ORGANIZATION_DELETED
  
  // Tenant Events
  TENANT_CREATED
  TENANT_UPDATED
  TENANT_DELETED
  TENANT_USER_ASSIGNED
  TENANT_USER_UNASSIGNED
  
  // Ticket Events
  TICKET_CREATED
  TICKET_UPDATED
  TICKET_DELETED
  TICKET_ASSIGNED
  TICKET_STATUS_CHANGED
  TICKET_PRIORITY_CHANGED
  TICKET_COMMENT_ADDED
  
  // KB Events
  KB_ARTICLE_CREATED
  KB_ARTICLE_UPDATED
  KB_ARTICLE_DELETED
  
  // Asset Events
  ASSET_CREATED
  ASSET_UPDATED
  ASSET_DELETED
  ASSET_ASSIGNED
  
  // Change Events
  CHANGE_CREATED
  CHANGE_UPDATED
  CHANGE_DELETED
  CHANGE_APPROVED
  CHANGE_REJECTED
  
  // Permission Events
  PERMISSION_GRANTED
  PERMISSION_REVOKED
}

model AuditLog {
  id            String         @id @default(uuid())
  organizationId String?      // null for global admin actions
  eventType     AuditEventType
  entityType    String        // "User", "Ticket", "Tenant", etc.
  entityId      String?
  userId        String        // Who performed the action
  userEmail     String        // Denormalized for historical accuracy
  description   String        @db.Text
  metadata      Json?         // Additional context (old values, new values, etc.)
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime      @default(now())

  organization  Organization?  @relation("AuditLogOrganization", fields: [organizationId], references: [id], onDelete: Cascade)
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([eventType])
  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
}

model AuditConfig {
  id            String   @id @default(uuid())
  organizationId String  @unique
  enabled       Boolean  @default(true)
  events        AuditEventType[] // Which events to track
  retentionDays Int?    // How long to keep logs (null = forever)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  organization  Organization @relation("AuditConfigOrganization", fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}
