module.exports=[6461,(e,t,i)=>{t.exports=e.x("zlib",()=>require("zlib"))},27699,(e,t,i)=>{t.exports=e.x("events",()=>require("events"))},24836,(e,t,i)=>{t.exports=e.x("https",()=>require("https"))},21517,(e,t,i)=>{t.exports=e.x("http",()=>require("http"))},4446,(e,t,i)=>{t.exports=e.x("net",()=>require("net"))},55004,(e,t,i)=>{t.exports=e.x("tls",()=>require("tls"))},92509,(e,t,i)=>{t.exports=e.x("url",()=>require("url"))},86682,e=>{"use strict";var t=e.i(15270),i=e.i(29173),s=e.i(73421),r=e.i(89610);async function a(){let e=new Date().getFullYear(),t=Math.floor(9e3*Math.random())+1e3;return`TKT-${e}-${t.toString().padStart(4,"0")}`}async function d(d){let u=await a();if(!d.requesterId&&(!d.requesterEmail||!d.requesterName))throw Error("Either requesterId or requesterEmail/requesterName must be provided");let n=await t.default.ticket.create({data:{ticketNumber:u,subject:d.subject,description:d.description,requesterId:d.requesterId||null,requesterEmail:d.requesterEmail||null,requesterName:d.requesterName||null,publicTokenId:d.publicTokenId||null,assigneeId:d.assigneeId||null,tenantId:d.tenantId||null,organizationId:d.organizationId||null,category:d.category||null,customFields:d.customFields?d.customFields:null,priority:d.priority??i.TicketPriority.MEDIUM,status:i.TicketStatus.NEW},include:{requester:!!d.requesterId&&{select:{id:!0,email:!0,firstName:!0,lastName:!0}},assignee:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},tenant:{select:{id:!0,name:!0,slug:!0}}}});s.wsServer.broadcastToAll("ticket:created",{ticket:{id:n.id,ticketNumber:n.ticketNumber,subject:n.subject,status:n.status,priority:n.priority,requester:n.requester||{email:n.requesterEmail||"",name:n.requesterName||""},assignee:n.assignee,createdAt:n.createdAt}});let c=n;if(!n.assigneeId&&d.tenantId&&d.category){let{routeTicketByCategory:i,assignTicketToAgent:s}=await e.A(28642),r=await i({ticketId:n.id,tenantId:d.tenantId,category:d.category});if(r){await s(n.id,r);let e=await t.default.ticket.findUnique({where:{id:n.id},include:{requester:!!d.requesterId&&{select:{id:!0,email:!0,firstName:!0,lastName:!0}},assignee:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},tenant:{select:{id:!0,name:!0,slug:!0}}}});e&&(c=e)}}return c.assigneeId&&await (0,r.notifyTicketCreated)(c.id,c.ticketNumber,c.assigneeId),c}async function u(i){let s={status:i?.status,priority:i?.priority,assigneeId:i?.assigneeId,requesterId:i?.requesterId,publicTokenId:i?.publicTokenId,tenantId:i?.tenantId,category:i?.category};if(i?.userId&&i?.userRoles&&!i.userRoles.includes("GLOBAL_ADMIN")){let e=await t.default.user.findUnique({where:{id:i.userId},select:{organizationId:!0}});if(!e?.organizationId)return[];s.organizationId=e.organizationId}if(i?.organizationId&&(s.organizationId=i.organizationId),i?.userId&&i?.userRoles&&i.userRoles.some(e=>["AGENT","IT_MANAGER"].includes(e))&&!i.userRoles.includes("GLOBAL_ADMIN")&&!i.userRoles.includes("ADMIN")){let{getUserAssignedCategories:t}=await e.A(7412),r=await t(i.userId);if(!(r.size>0))return[];{let e=[];if(r.forEach((t,i)=>{t.size>0&&e.push({tenantId:i,category:{in:Array.from(t)}})}),!(e.length>0))return[];s.OR=e}}return Object.keys(s).forEach(e=>{void 0===s[e]&&delete s[e]}),t.default.ticket.findMany({where:s,orderBy:{createdAt:"desc"},include:{requester:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},assignee:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},tenant:{select:{id:!0,name:!0,slug:!0}}}})}async function n(e){return t.default.ticket.findUnique({where:{id:e},include:{requester:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},assignee:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},tenant:{select:{id:!0,name:!0,slug:!0}},comments:{orderBy:{createdAt:"asc"},include:{author:{select:{id:!0,email:!0,firstName:!0,lastName:!0}}}}}})}async function c(e,a){let d=await t.default.ticket.findUnique({where:{id:e},include:{requester:{select:{id:!0}},assignee:{select:{id:!0}}}});if(!d)throw Error("Ticket not found");let u=await t.default.ticket.update({where:{id:e},data:{subject:a.subject,description:a.description,status:a.status,priority:a.priority,assigneeId:a.assigneeId,closedAt:a.status===i.TicketStatus.CLOSED?new Date:void 0},include:{requester:{select:{id:!0,email:!0,firstName:!0,lastName:!0}},assignee:{select:{id:!0,email:!0,firstName:!0,lastName:!0}}}}),n={};a.status&&a.status!==d.status&&(n.status={from:d.status,to:a.status}),a.priority&&a.priority!==d.priority&&(n.priority={from:d.priority,to:a.priority}),void 0!==a.assigneeId&&a.assigneeId!==d.assigneeId&&(n.assigneeId={from:d.assigneeId,to:a.assigneeId}),s.wsServer.broadcastToTicketSubscribers(e,"ticket:updated",{ticket:{id:u.id,ticketNumber:u.ticketNumber,subject:u.subject,status:u.status,priority:u.priority,requester:u.requester,assignee:u.assignee,updatedAt:u.updatedAt},changes:n});let c=[];return u.requesterId&&c.push(u.requesterId),u.assigneeId&&c.push(u.assigneeId),d.requesterId&&!c.includes(d.requesterId)&&c.push(d.requesterId),d.assigneeId&&!c.includes(d.assigneeId)&&c.push(d.assigneeId),Object.keys(n).length>0&&c.length>0&&await (0,r.notifyTicketUpdated)(u.id,u.ticketNumber,n,c),void 0!==a.assigneeId&&a.assigneeId!==d.assigneeId&&a.assigneeId&&(await (0,r.notifyTicketAssigned)(u.id,u.ticketNumber,a.assigneeId),s.wsServer.broadcastToUser(a.assigneeId,"ticket:assigned",{ticket:{id:u.id,ticketNumber:u.ticketNumber,subject:u.subject}})),u}async function l(e){let i=await t.default.ticket.findUnique({where:{id:e.ticketId},include:{requester:{select:{id:!0}},assignee:{select:{id:!0}},comments:{select:{authorId:!0},distinct:["authorId"]}}});if(!i)throw Error("Ticket not found");let a=await t.default.ticketComment.create({data:{ticketId:e.ticketId,authorId:e.authorId,body:e.body},include:{author:{select:{id:!0,email:!0,firstName:!0,lastName:!0}}}});s.wsServer.broadcastToTicketSubscribers(e.ticketId,"ticket:comment",{ticketId:e.ticketId,comment:{id:a.id,body:a.body,author:a.author,createdAt:a.createdAt}});let d=[];return i.requesterId&&d.push(i.requesterId),i.assigneeId&&d.push(i.assigneeId),i.comments.forEach(e=>{e.authorId&&!d.includes(e.authorId)&&d.push(e.authorId)}),d.length>0&&await (0,r.notifyTicketComment)(e.ticketId,i.ticketNumber,e.authorId,d),a}async function o(e,i){return(await t.default.ticket.updateMany({where:{publicTokenId:e,requesterId:null},data:{requesterId:i,publicTokenId:null}})).count}e.s(["addTicketComment",()=>l,"createTicket",()=>d,"generateTicketNumber",()=>a,"getTicketById",()=>n,"listTickets",()=>u,"mergePublicTokenTicketsToUser",()=>o,"updateTicket",()=>c])},28642,e=>{e.v(t=>Promise.all(["server/chunks/lib_services_ticket-routing-service_ts_1e1adca9._.js"].map(t=>e.l(t))).then(()=>t(43887)))},7412,e=>{e.v(t=>Promise.all(["server/chunks/lib_services_tenant-service_ts_e0fbdcc5._.js"].map(t=>e.l(t))).then(()=>t(16766)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__70fe9959._.js.map